## 一二级菜单以及权限配置

- 在`configure.php`中,创建新的数组(按照它原先的格式),一级数组是一级菜单,二级数组是二级菜单,二级数组的元素就是权限,然后到公司官网里的项目代码里更新之后,再到管理员权限里打钩,就可以显示新的一级二级页面.

## 面向对象

- 现在的公司框架采用了一部分面向对象的思想,但凡有需要单独建立数据库表的模块,就需要单独建一个类(Class文件),其中大致分为五个部分

  1. `listSearch`方法,这个方法定义了我们当前页面表格的搜索框.需要去`listSearch`中注册类.

     ```php
     public function listSearch(){
             $result['html'] = "";
             $result['html'] .=
                 text(array("name" => "userName","title" => "会员名称")).
                 text(array("name" => "userCard","title" => "会员卡号")).
                 text(array("name" => "birthday","laydate" => array(),"title" => "生日"));
             //返回
             return $result;
         }
     ```

     

  2. `listReasult`方法,这个方法定义了具体的页面,包括表格以及表格的所有行列,表头的各个按钮,以及表中的针对每条数据的编辑按钮.写好之后需要去`listReasult.php`注册类.

  3. `tab`方法,用来定义详情页的分支页面,第一个分支页面是写在`detailPara.php`中,自从第二个开始,就需要写在类文件中,最终需要注册在`detailTab.php`文件中,第二个分支的方法在类中必须起名为tab,因为这个是默认名,在注册时填三个参数即可,如果你有两个以上的分支,第三个分支的时候你就可以自定义类中的分支方法名,这个方法名在注册的时候,需要加上第四个参数"fun" => "方法名".

  4. 弹出层方法,用来定义弹出层的页面显示,格式为`xxxLayer`,以Layer结尾,写好之后需要到`layer.php`中去注册,注册时需要填类名以及方法名(方法名只需要填后缀Layer之前的部分).

  5. 异步数据处理方法,用来处理弹出层或者是单个页面的表单提交的数据,格式为`xxxData`,以Data结尾,写好之后需要去`data.php`注册类(方法名只需要填后缀Data之前的部分).

     ```php
     "workHolidayClass" => array("workHoliday","adWorkAuditing","workHolidayRebut"),
            "workAddClass" => 
     ```

## 增查删改

### 增

- 公司框架大多数使用的是异步处理数据,所以增类的方法一般都是写在类文件中,以Data结尾,写完之后去`data.php`注册类即可.

### 查

- 所有查询功能,基本上搜索框是写在类文件中的`listSearch`方法,如果有下拉搜索框,就需要先去para数据库表中建一个字段,以逗号分割放入下拉搜索框的所有选项.当然写完之后需要去`listSearch.php`中注册才能显示注册框.

- 如果你不想让当前页面显示搜索框以及搜索按钮,你只需要在类文件的`listSearch`方法中定义一个空的html返回去即可.

  ```php
  public function listSearch(){
          $result['html'] = "";
          //返回空html
          return $result;
      }
  ```

### 删

- 删除功能都是写在`delete.php`文件中,似乎也可以写在类文件,但是我目前还没研究出具体怎么写在类文件中

- 首先删除按钮上绑定了js方法用以获取表单提交的数据,按钮还携带了复选框的多个id,以及携带的状态,在`delete.php`中就是靠elseif判断状态是否是对应的删除方法的.

- 删除中一般使用post获取id,这个id的名字是可以变动的,不一定就叫id,也可能是userId,具体叫什么,取决于具体页面中定义的多选框中起的id名.

  ```php
  elseif($get['type'] == "deleteClient"){
      $array = $post['userId'];  //这里这个post得到的userId是在Class中起好的名字
  ```

  ```php
  $checkbox  = "<input name='userId[]' type='checkbox' value='".$array['khid']."'/>";
  //userId的名字就起在这个Class中的input框中
  ```

### 改

- 修改的方法和新增一般是写在同一个方法中,方法中用是否有主键id为区分,各自写好新增与修改的功能.

## 弹出层

### 基础

- 一般是在类文件中写好Layer为后缀的弹出层页面显示方法,然后去`layer.php`中注册即可显示弹出层,在这个方法中,还可以夹带隐藏域input标签,和表单一起提交,非常的方便.
- 具体弹出层数据的处理方法也就是类文件中的Data结尾的数据处理方法了.

### 进阶

- 如果想让弹出层**不显示提交按钮**,该怎么做呢?应该去`layer.php`中判断,如果你得到的type不是你需要让提交按钮不出现的那个弹窗,就让他正常运行代码生成button,这也就意味着你如果得到了你需要让提交按钮不出现的那个弹窗的type,提交按钮就不会生成.

  ```php
  if($data['type']!='adUserExport'){   
      //如果有多个不让生成提交按钮的弹出层,就在这括号里后接or $data['type']!='你不想生成按钮的弹出层'
            if(empty($result['button'])){
                  if(empty($result['formTwo'])){
                     $result['button'] = $this->button();
                  }else{
                     $result['button'] = $this->button(array("formTwo" => $result['formTwo']));
                        }
                  }
                 }
  ```

------

- **弹出层**按道理是会携带主页面表格**复选框选中的id**的,也就可以拿着这些id做对应的操作,那么**如何拿到**?

- 在Class中的弹出层方法里,携带listForm传给$result,起名为formTwo,因为在layer的按钮生成方法里会去拿这个formTwo,意思是提交的第二个表单.

  ```php
   public function adUserCountLayer($data){
         $result = array("title" => "添加次数","height" => 190,"width" => 600);
         $result['table'] = array(
             "温馨提示：" => "<span class='smallWord'>您正在增加会员的剩余次数。</span>",
             must."输入次数：" => text(array(
                 "name" => "adUserCount",
                 "value" => "",
                 "class" => "text textPrice",
             )),
             must."登录密码：" => password(array("name" => "password","class" => "text textPrice")),
         );
         $result['formTwo'] = 'listForm';  //这一句就可以把页面表单复选框的id传过去,起名为formTwo
         return $result;
   
     }
  ```

  ```php
   public function button($data = ""){
          if(!empty($data['formTwo'])){
              //在这里会判断有没有需要提交的第二个表单名称,如果有就拿到,自然就拿到了我们需要的id
              $formTwo = ",".$data['formTwo'];
          }
          return "<input onclick=\"subForm('".$this->type."Form".$formTwo."',root+'control/data.php?type=".$this->type."')\" type='button' class='button' value='确认提交'>";
      }
  ```

### 改造框架中的layer

- 不想要layer中有默认按钮,就去layer中,把生成按钮部分的代码排除你的那个layer名

  ```php
  if($data['type']!='adUserExport'&&$data['type']!='equitiesContext'){
      if(empty($result['button'])){
          if(empty($result['formTwo'])){
              $result['button'] = $this->button();
          }else{
              $result['button'] = $this->button(array("formTwo" => $result['formTwo']));
          }
      }
  }
  ```

- 不想要layer中有默认自带的id隐藏域同理

  ```php
   //在指定的弹出层内不要加ID隐藏域
                  if($data['type']!='equitiesContext'){
                      $result['table'][$hidden] = $result['button'];
                  }
  ```

- ```php
  //如果要自定义提交按钮,就重新定义button,只要在layer函数中传asyn就可以(asyn这个名字你随便起,叫abc都行)
  if(!empty($result['asyn'])){//khidSubForm是重定义的表单提交JS方法
      $result['button'] = "<input onclick=\"khidSubForm('".$this->type."Form".$formTwo."',root+'control/data.php?type=".$this->type."')\" type='button' class='button' value='确认提交'>";
  }
  
  //改良版本,如果要重定义按钮,就穿$result['asyn'],值为自定义的异步提交JS方法名,然后把传过来的方法名拼接到按钮上即可
  if(!empty($result['asyn'])){
      $result['button'] = "<input onclick=\"".$result['asyn']."('".$this->type."Form".$formTwo."',root+'control/data.php?type=".$this->type."')\" type='button' class='button' value='确认提交'>";
  }
  ```

  ```php
  public function addUserLayer($data)
  {
      $result = array("title" => "新增会员", "height" => 234, "width" => 600);
  
      $result['table'] = array(
  
          "会员名称：" => text(array("name" => "name","class"=>"addUser")),
          "性别" => radio(array("name" => "sex","class"=>"addUser","value" => array("男","女"))),
          "会员手机号：" =>  text(array(
              "name" => "phone",
              "class"=>"addUser",
          )),
          "备注" => textarea(array(
              "name" => "text",
              "class"=>"addUser",
          )),
      );
      $result['asyn'] = 1;//随便传个asyn过去就可以满足layer.php中我们定义的条件.就可以自定义异步提交按钮
  
      return $result;
  
  }
  ```

  ```js
  /********收银页面-新增会员带客户ID到第一弹出层-异步提交函数**************************/
  //form支持多表单提交，中间用,隔开，url为提交地址
  function khidSubForm(form,url){
      //防止高频点击
      var date = new Date();
      var time = date.getTime();//毫秒时间戳
      if(typeof minTime == "undefined"){
          var finger = 2;
          minTime = time+2000;//下次点击的最小时间
          console.log("定义minTime");
      }else{
          if(minTime && time < minTime){
              var finger = 1;
              warn("操作过于频繁");
              console.log("time:"+time+"，mintime:"+minTime+"，差额："+(time-minTime));
          }else{
              var finger = 2;
              console.log("time:"+time+"，mintime:"+minTime+"，多出："+(time-minTime));
              minTime = time+2000;//下次点击的最小时间
          }
      }
      if(finger == 2){
          //串联表单
          var formName = form.split(",");
          var serialize = "";
          var a = "";
          console.log(formName.length);
          for(var i=0;i<formName.length;i++){
              if(serialize == ""){
                  a = "";
              }else{
                  a = "&";
              }
              if(formName[i] != ""){
                  serialize += a + $("[name="+formName[i]+"]").serialize();
              }
          }	
          //异步提交数据
          $.post(url,serialize,function(data){
              //console.log(data);
              if(data.status == 2){//这里不能用data.warn==2判断了,应该自定义一个传过来的值,我用了status.
                  warn(data.warn);//这里要写弹窗,因为如果你不想刷新,还要弹出这个新增成功,就必须在JS里调用弹窗方法.
                  //如果传了2,就可以把对应客户ID传递到初始弹窗
                  $('#placeAnOrder').find("[name=khid]").attr('value',data.khid);//改变房间内容
  
                  $('div').find("[name=userTel]").text(data.phone);//改变房间内容
                  $('div').find("[name=userName]").text(data.userName);//改变房间内容
                  $('div').find("[name=userLevel]").text(data.userLevel);//改变房间内容
                  $('div').find("[name=svip]").text(data.svip);//改变房间内容
                  $('div').find("[name=userPoint]").text(data.userPoint);//改变房间内容
                  $('div').find("[name=balance]").text(data.balance);//改变房间内容
                  $('div').find("[name=secretRoomCount]").text(data.secretRoomCount);//改变房间内容
                  $('div').find("[name=mergeCount]").text(data.mergeCount);//改变房间内容
  
                  $('span').find("[name=equitiesContext]").attr('onclick',"layer('equitiesContext',{'khid':'"+data.khid+"'})");//改变房间内容
              }else{
                  warn(data.warn);
              }
          },"json");
      }
  }
  ```



## 导入导出

### 导出

- 从数据库读取备注和字段名的情况下,使用以下代码.去data.php写

  ```php
  /************************员工管理-导出excel*****************************/
  //到这个页面去完成导出功能
  elseif($get['type'] == 'adminExport'){
     //查询你要导出的数据库表的所有备注和字段名
      $adminArr = sqlQueryAll("SELECT  
                          COLUMN_NAME as `字段名`,  
                          COLUMN_COMMENT  AS  `备注`  
                          FROM information_schema.COLUMNS WHERE TABLE_NAME='admin'");
  
      foreach ($adminArr as $thing){
          //如果表中有用不到的字段就用判断排除
          if($thing['字段名']!="time"&&$thing['字段名']!="companyId"&&$thing['字段名']!="adid"
              &&$thing['字段名']!="adDutyId"&&$thing['字段名']!="personalSocialSecurityType"&&$thing['字段名']!="companySocialSecurityType"
              &&$thing['字段名']!="adLoginName"&&$thing['字段名']!="manager"&&$thing['字段名']!="state"
              &&$thing['字段名']!="adpas"&&$thing['字段名']!="touxiang"&&$thing['字段名']!="IDCardFront"
              &&$thing['字段名']!="IDCardBack"&&$thing['字段名']!="diploma"&&$thing['字段名']!="bankIco"
              &&$thing['字段名']!="picture"&&$thing['字段名']!="lastMoney"&&$thing['字段名']!="money"
              &&$thing['字段名']!="socialSecurity"&&$thing['字段名']!="socialSecurityNum"&&$thing['字段名']!="gateKey"
              &&$thing['字段名']!="schoolEnd"&&$thing['字段名']!="IDCardRegionId"&&$thing['字段名']!="liveRegionId"
              &&$thing['字段名']!="dingtalkId"&&$thing['字段名']!="loginErrorNum"&&$thing['字段名']!="loginErrorDay"
              &&$thing['字段名']!="jobNum"
          ){
              $wordArr[$thing['字段名']] = $thing['备注'];
          }
      }
       //取出session中存储的模糊查询sql语句
      $admin = sqlQueryAll($_SESSION['adminSql']);  //查你要导出的数据的那张表
      $config = [
          'path' => getTmpDir() . '/',
      ];
      $name = "员工记录".date("YmdHis").".xlsx";
      $fileName   = $name ;
      $xlsxObject = new \Vtiful\Kernel\Excel($config);
  
  // Init File
  //    $fileObject = $excel->fileName($fileName);
      $fileObject = $xlsxObject->fileName($fileName);
      $head = array();
      $word = array();
      $sqlWord = array();
  
          $head[] = "工号";
          foreach ($wordArr as $k=>$v){
              $sqlWord[] = $k;   //一维数组,字段名,英文
              $head[] = $wordArr[$k];  //一维数组,表头,中文
          }
  
          foreach ($admin as $c){
              $box = array();  //一维数组,放每个数据,直到塞满一条就清空
              $box[] = $c['jobNum'];
              foreach ($sqlWord as $english) {
                  $box[] = $c[$english];
              }
              $word[] = $box; //二维数组,[0] => 第一条数据,[1] => 第二条数据
          }
  
  // Writing data to a file ......
      $fileObject->header($head)->
      data($word);
  // Outptu
      $filePath = $fileObject->output();
  
  // Set Header
      header("Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
      header('Content-Disposition: attachment;filename="' . $fileName . '"');
      header('Cache-Control: max-age=0');
  
      if (copy($filePath, 'php://output') === false) {
          // Throw exception
      }
  
  // Delete temporary file
      @unlink($filePath);
  }
  ```

## 小功能

### 选择字段显示对应字段表格

- ```sql
  SELECT  
  COLUMN_NAME,  
  COLUMN_COMMENT  AS  `备注`  
  FROM information_schema.COLUMNS WHERE TABLE_NAME='xxx_table_name'  //表名就算是关键字,也不用加``.
  ```

- ```php
  $wordArr = sqlQueryAll("SELECT  
                         COLUMN_NAME as `字段名`,  
                         COLUMN_COMMENT  AS  `备注`  
                         FROM information_schema.COLUMNS WHERE TABLE_NAME='check'");
    
         foreach ($wordArr as $thing){
             //如果表中有用不到的字段就用判断排除,导出时必须要,但是导入时这一步没必要,因为多余字段筛选不到
             if($thing['字段名']!="time"&&$thing['字段名']!="id"&&$thing['字段名']!="adid"){
                 $word[$thing['字段名']] = $thing['备注'];
             }
         }
  ```

  ```php
  /**
   * 先通过我们要拿的字段名,去$key中找到对应的数字键,拿着这个键,去$v[$performanceAwardKey]找到对应的数据
   * @param $string 要找寻的字段
   * @param $v 具体的数据数组 array(3) { [0]=> int(233) [1]=> int(6) [2]=> int(11) }
   * @param $key 数据库字段数组 array(3) { [0]=> string(6) "jobNum" [1]=> string(11) "foodSubsidy" [2]=> string(7) "subsidy" }
   * @return mixed
   */
  function findKey($string,$v,$key,$existSalary)
  {
      $k = array_search($string,$key);
      if($k == false){//如果array_search返回false,说明现在需要的数据,不在我们导入的excel表格中
          $result  = findSalaryData($string,$existSalary);//那我们就先从本年本月这条salary数据中去拿
          if(empty($result)){//如果拿到的为空,那就给它赋值为0
              $result = 0;
          }
      }else{//如果没返回false,那就说明我们需要的数据在导入的excel表格中存在,那就直接拿出来用.
          $result  = $v[$k];
      }
      return $result;
  }
  
  function findSalaryData($string,$existSalary)
  {
      return $existSalary[$string];
  }
  ```

---

- 点击按钮切换列表显示分类,使用一种新而简单的方法.

- 如果在tab分支中,就在$edit前面拼接

  ```php
  $html = "<p>"."<div style='margin: 12px;'>
                  <span class='bigSpan choice' onclick=\"switchCoupon(this,'未使用')\">未使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已使用')\">已使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已失效')\">已失效</span>
                  </div>".
              "</p>".$edit.space."<form name='couponForm'>".tableMany(array("tr" => $tr))."</form><script>
  ```

- 如果是主页面就在listSearch中拼接.

- 然后使用重写的JS方法`switchCoupon`

- 直接去异步添加Session,然后在列表处拼接SQL,判断不同的session拼接不同的条件.

  ```php
  /**********切换优惠券列表**********/
  elseif($get['type'] == "saveCouponSession") {
      $_SESSION['haveCouponWorkFlow'] = $post['workFlow'];
      $json['href'] = root."control/detail.php?type=adUser&menu=coupon&id=".$post['khid'];
  }
  ```

  

- 直接把回显按钮高亮的那部分html也在这个session判断中完成即可.

  ```php
  /**********切换优惠券列表**********/
  //反正现在Class的切换是由php代码完成,这里就不用去掉/添加html的class了
  function switchCoupon(e,workFlow,khid) {
      $.post(root+"control/data.php?type=saveCouponSession",{workFlow:workFlow,khid:khid},function(data){
          window.location.href = data.href;
      },"json");
  }
  ```

  ```php
  if($_SESSION['haveCouponWorkFlow']=='已使用'){
      $sql  = "and workFlow = '已使用'";
      $switch = "
                  <span class='bigSpan' onclick=\"switchCoupon(this,'未使用','$userId')\">未使用</span>
                  <span class='bigSpan choice'  onclick=\"switchCoupon(this,'已使用','$userId')\">已使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已失效','$userId')\">已失效</span>
                  ";
  }elseif ($_SESSION['haveCouponWorkFlow']=='已失效'){
      $sql  = "and workFlow = '已失效'";
      $switch = "
                  <span class='bigSpan' onclick=\"switchCoupon(this,'未使用','$userId')\">未使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已使用','$userId')\">已使用</span>
                  <span class='bigSpan choice'  onclick=\"switchCoupon(this,'已失效','$userId')\">已失效</span>
                  ";
  }else{
      $sql  = "and workFlow = ''";
      $switch = "
                  <span class='bigSpan choice' onclick=\"switchCoupon(this,'未使用','$userId')\">未使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已使用','$userId')\">已使用</span>
                  <span class='bigSpan'  onclick=\"switchCoupon(this,'已失效','$userId')\">已失效</span>
                  ";
  }
  $haveCoupon = sqlQueryAll("select id,workFlow,couponId,time from haveCoupon
                        where khid = '$userId'".$sql);
  ```

- 当然CSS少不了

- ```css
  .choice{
      background-color: #3e97ff!important;
      color: #ffffff!important;
  }
  .bigSpan{
      padding: 0px 6px 0 6px;
      border: 1px solid #cddba2;
      border-radius: 4px;
      background-color: #ffffff;
      color: #7d6b6b;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
      font-size: 20px;
      margin: 10px;
      position: relative;
  }
  .numEm{
      position: absolute;
      color: black;
      top: -11px;
      right: -16px;
      width: 20px;
      background-color: yellow;
      text-align: center;
      font-style: normal;
      font-size: 13px;
  }
  ```

### 导入

- 去post.php里写代码,从数据库直接拿备注和字段名,就用以下代码.

  ```php
  elseif ($get['type'] == 'importChangeRecord') {
      //赋值
      $password = $post['password'];
  //判断
      if (!power("admin", "import")) {
          $warn = "权限不足";
      } elseif (empty($password)) {
          $warn = "管理员登录密码为空";
      }elseif (empty($_FILES['adjustExcel']["tmp_name"])) {
          $warn = "没有上传文件";
      }
      elseif (md5($password) != $control['adpas']) {
          $warn = "管理员登录密码输入有误";
      } else {
          $adid = $_GET['adid'];
  
          $adminArr = sqlQueryAll("SELECT  
                          COLUMN_NAME as `字段名`,  
                          COLUMN_COMMENT  AS  `备注`  
                          FROM information_schema.COLUMNS WHERE TABLE_NAME='adjust'");
  
          foreach ($adminArr as $thing){
              //导出时这里如果表中有用不到的字段就用判断排除,但导入不用,因为导入的数组会去我们从数据库拿到的字段名一一对应,对应上了才会塞进数据库.
              $wordArr[$thing['字段名']] = $thing['备注'];//字段名为key,备注为value.
          }
          $name = $_FILES['adjustExcel']["tmp_name"];
          $successNum = 0;
  
  
          $config   = ['path' => ''];
          $excel    = new \Vtiful\Kernel\Excel($config);
  
           /******excel表格中时间列筛选*******/
          $dataHead = $excel->openFile($name)
              ->openSheet()
              ->getSheetData();
          foreach ($dataHead as $k => $v){
              if($k==0){
                  $head = $v;
              }
          }
          $timeArr = array("调岗时间");//所有要转换的时间列表头手动写为一个数组
          $temp = array();
          $tempKey = array();
          foreach ($timeArr as $t){
              $adjustTime = array_search($t,$head);
              $temp[$adjustTime] = \Vtiful\Kernel\Excel::TYPE_TIMESTAMP;
              $tempKey[] = $adjustTime;
          }
          /*********时间列筛选结束********/
  
          $data = $excel->openFile($name)
              ->openSheet()
              ->getSheetData();
          mysqli_autocommit($con,false);//表示事务开始
          $word = array();
          //遍历excel表格中的数据,第一行表头存到head,其余数据存word
          foreach ($data as $k => $v){
              if($k==0){//只存第一行,因为第一行是表头
                  $head = $v;//一维数组,存表头中文
              }else{
                  $word[] = $v;//一维数组
              }
          }
          $key = array();
          //把表头数组遍历,在我们写好的字段数据$show中找到对应的字段名,存入key数组.
          foreach ($head as $v){
              $one = array_search($v,$wordArr);
              $key[] = $one;
          }
  
  
          foreach ($word as $kk=>$v){
              $field = array();
  
  
  
              foreach ($v as $k => $a){
                   if(in_array($k,$tempKey)){
                      $a = date('Y-m-d',$a);
                  }//时间戳格式处理
                      $field[$key[$k]] =  $a;
              }
  
                  $field['adid'] = $adid;
                  $field['id'] = suiji();
                  $field['time'] = $date;
  
                  $success[] = insert(array("table" => "adjust","field" => $field));
  
  
  
          }
  //        var_dump($successNum);
          foreach ($success as $successKey => $successValue){
              if($successValue == "新增成功"){
                  unset($success[$successKey]);
                  $successNum++;
              }
              else{
                $failedNum = $successKey+1;
                  $failed .= $failedNum." ";
              }
  
          }
          $success = array_values($success);
  
          if(count($success)<1){
              mysqli_commit($con);
          }else{
              mysqli_rollback($con);
          }
  
          mysqli_autocommit($con,true);//表示事务结束
  
          $text = "导入如果出现问题,问题分别出现在第".$failed."行";
          logText(array("type" => "admin","text" => $text));
          $warn = "导入了{$successNum}条调岗信息,如有问题请到系统日期查看详情";
      }
  }
  ```

  

## 分支(tab)

### 分支菜单

- 如果想要写分支tab的方法,按框架要求是要写在Class中的,起不同的方法名,去`detailTab.php`中注册即可.

- 分支页面的第一个,是写在`detailPara.php`中的,写的时候可以**定义分支菜单**的各个按钮,但是要注意,写好之后必须把`$menu`写进`$para`里,不然是不会显示分支菜单的

  ```php
  $menu = array("edit" => "基本信息","info" => "辅助信息");//分支菜单数组
  $para = array("id" => $adDuty['id'],"title" => $adDuty['department']."-".$adDuty['name'],"button" => "更新","menu" => $menu); //分支菜单需要放到$para中才生效
  ```

  

### 分支页面

- 分支页面的生成

  - 按钮的名字定义在`detailPara.php`中写的第一个分支页面中.

  - 第一个页面写在`detailPara.php`中

  - 第二个页面写在Class中,方法名为tab.写完之后去`detailTab.php`中注册.

  - 从第三个开始也是写在Class中,但是名字可以自定义,写完之后也是去`detailTab.php`中注册,但是注册填的东西不太一样,数组中需要多填一个元素key为"fun",value为Class中的分页方法名.

    ```php
    //就在这里注册,type不用多说,menu就是你在detailPara中定义的,Class就是写在了哪个类里
    $class = array(
            array("type" => "adClient","menu" => "info","class" => "clientClass"),
            array("type" => "adClient","menu" => "out","class" => "workOutClass"),
            array("type" => "adClient","menu" => "add","class" => "workAddClass"),
            array("type" => "adClient","menu" => "invoice","class" => "invoiceClass"),
            array("type" => "adDevelop","menu" => "out","class" => "workOutClass"),
            array("type" => "adDevelop","menu" => "add","class" => "workAddClass"),
        );
    ```

    ```php
    //菜单数组,detailtab中注册类时的tab就写在这里(detailPara)
       $menu = array("edit" => "基本信息", "tag" => "会员标签", "history" => "历史主题");
    ```

    ```php
    //根据detailTab中的这段代码,可以得到一些信息,那就是上面的类注册代码中,我们可以看到都没有下面这段代码中的$value['fun'],为什么呢?因为都还没传递,如果传递之后,就说明你在同一个类里,写了第二个或更多的分支方法,需要用这个$value['fun']来区分,$value['fun']也就是我们的分支方法名.
    //$value['fun']默认是tab,也就是说如果我们只在Class中写了一个分值方法,那这个方法必须用这里规定的默认值为方法名,也就是tab为方法名.
     foreach($class as $value){
            if($get['type'] == $value['type'] and $get['menu'] == $value['menu']){
                $name = $value['class'];
                if(empty($value['fun'])){
                    $fun = "tab";
                }else{
                    $fun = $value['fun'];
                }
            }
        }
    ```

------

- 如果要**在Class写tab分页**,需要像listResult方法一样,去使用多选,还有多选删除,那就都给表格头的按钮起一样的名字,第一个$edit,后面的都用$edit.=来拼接.(等于把复选框,弹出层,按钮都写出来,然后把它们都拼到$edit里)

  ```php
  $edit = checkAll("userTagForm", "id");  //复选框获取标签id
   
         if(power("adUser","editTag")){
             //在本类里写layer弹出层方法
             $edit .= "<span class='spanButton' title='给会员添加标签' onclick=\"layer('adUserAddSingleTag',{'id':'$_POST[id]'})\">添加标签</span>&nbsp;";
         }
         if(power("adUser","delTag")){
             //去delete中写删除方法
             $edit .= "<span class='spanButton' title='删除会员的标签' onclick=\"pasWarn('userTagForm','adUserDelSingleTag')\">删除</span>";
         }
  ```

------

- 如果要在一个**详情页面插入表格**,前提是这个页面已经有输入框,上传框之类的东西,那就在本来插入输入框的位置插入html标签,引号内不能写php代码,就在外部代码部分写好循环生成表格的代码(类似Class中tab的代码),赋给一个变量$x,最后把$x拼给双引号内部.

- 这样子插入的表格会很不好看,可以在html中插入一个style标签写好样式,把表格背景改为白色,表格字体居中

- ```php
  //style标签就是这样插入的
  $html = $edit.space."<style>.tableMany td{background-color: white!important;
      text-align: center!important;}</style><form name='roundForm'>".tableMany(array("tr" => $tr))."<input name='themeId' style='display: none' value='$themeId' /></form>";
  
  ```

### 注意事项

- 新框架中的分支页,**第一个分支页在$menu中必须起名为edit**,改为其他的就会出现问题,当你点击其他分支再点回第一个就回不来了.

  ```php
  $menu = array("edit" => "岗位信息", "personal" => "个人资料", "join" => "入职信息", "salary" => "薪资信息", "insurance" => "保险信息", "change" => "调岗记录");
  ```

### 数据操作

- 新框架中,如果想要**在第二,三甚至之后的分支页面中**完成像第一个edit分支一样的**对主表的数据操作更新**.

- 那就需要自己在Class中写的分支方法中用form标签把自己写好的那堆输入框下拉框包裹起来

- 然后在form包裹区域的最后连接上一个自己写的按钮标签.

- 如果有区域联动下拉,那他们的formName部分要写自己写的那个form标签的name进去.

- 在提交按钮的subForm方法中,那个跳转到data.php的链接最后的type就对应你在Class中写的处理数据方法名,当然是无Data后缀的.

  ```php
   public function tab($data){
  //定义参数
          $id = $data['post']['id'];
  
              $admin = query("admin", " adid = '$id' ");
  
  
              if (empty($admin['adid'])) {
                  $para['warn'] = "未找到此员工";
              } else {
                  $button = "更新";
              }
  
          $trData = array(
              array(
                  must."性别：" => select(array("name" => "sex","title" => "选择性别","option" => explode(",",para("sex")),"value" => $admin['sex'])),
                  "生日：" => text(array("name" => "birthday","laydate" => array(),"title" => "生日","value" => $admin['birthday'])),
              ),
              array(
                  must."年龄：" => text(array("name" => "age","value" => $admin['age'])),
                  "民族：" => text(array("name" => "nationality","value" => $admin['nationality'])),
              ),
              array(
                  must."户口性质：" => text(array("name" => "residence","value" => $admin['residence'])),
                  "婚否：" => select(array("name" => "isMarry","title" => "选择性别","option" => explode(",",para("isMarry")),"value" => $admin['isMarry'])),
              ),
              array(
                  "生育：" => select(array("name" => "hasChild","title" => "生育与否","option" => explode(",",para("hasChild")),"value" => $admin['hasChild'])),
                  "政治面貌：" => select(array("name" => "politicsStatus","title" => "生育与否","option" => explode(",",para("politicsStatus")),"value" => $admin['politicsStatus'])),
              ),
              array(
                  "档案地址：" => text(array("name" => "fileAddress","value" => $admin['fileAddress'])),
                  "学历：" => select(array("name" => "educationalBackground","title" => "学历","option" => explode(",",para("educationalBackground")),"value" => $admin['educationalBackground'])),
                  ),
              array(
                  must."毕业学校：" => text(array("name" => "school","value" => $admin['school'])),
                  "专业：" => text(array("name" => "schoolMajor","value" => $admin['schoolMajor'])),
                  ),
              array(
                  "证书：" => text(array("name" => "certificate","value" => $admin['certificate'])),
                  "电子邮箱：" => text(array("name" => "email","value" => $admin['email'])),
              ),
              array(
                  "联系电话：" => text(array("name" => "phone","value" => $admin['phone'])),
                  "身份证号：" => text(array("name" => "IDCard","value" => $admin['IDCard'])),
              ),
              array(
                  "身份证居住地址：" => regionSelect('personalForm',$admin['IDCardRegionId']).
                      text(array("name" => "liveAddress","value" => $admin['IDCardAddress'])),
              ),
              array(
                  "工资卡号：" => text(array("name" => "bankNum","value" => $admin['bankNum'])),
                  "开户行：" => text(array("name" => "bankName","value" => $admin['bankName'])),
              ),
              array(
                  "紧急联系人：" => text(array("name" => "urgencyContact","value" => $admin['urgencyContact'])),
                  "紧急联系人电话：" => text(array("name" => "urgencyPhone","value" => $admin['urgencyPhone'])),
              ),
              array(
                  "现居住地址：" => regionSelect('personalForm',$admin['liveRegionId']).
                      text(array("name" => "liveAddress","value" => $admin['liveAddress'])),
              ),
          );
          $photo = array(
              //头像字段用作员工照片,身份证正面字段用作证件照片
              array("title" => "员工照片","url" => $admin['picture'],"type" => "picture","id" => $admin['adid']),
              array("title" => "身份证","url" => $admin['IDCardFront'],"type" => "IDCardFront","id" => $admin['adid']),
          );
          ;
          $html = "<form name='personalForm'>".tableEdit($trData).
              "<div onclick=\"subForm('adminPersonalForm',root+'control/data.php?type=adminPersonalEdit')\" class='formButton'>".$button."</div>".
              "</form>".photo($photo);
          return $html;
      }
  
  ```

### 分支页面点击按钮切换表格显示范围

- 在类中的tab分页里写切换表格显示的按钮,可能会遇到一些问题

- 首先就是写的隐藏域hidden的value不能用`$date['post']`拿到,因为就在本页面根本不是post.

- 所以就需要换个思路,改写js方法.

- 首先从`detail.php`文件中可以看到,切换tab分页的方法就是一个叫`detailTab()`的方法,切换分页同时带三个值过来,这三个值也是这方法的条件参数,分别是type,menu,id.

  - type:`configure.php`中定义的当前页面的英文名

  - menu:`detailPara.php`中定义的tab分页的按钮menu代号

  - id:自然就是我们点进详情的这条数据的主ID

    ```js
    /*******详情页选项卡切换***********************************************/
    function detailTab(type,menu,id){
    	//切换导航
    	$("#pageMenu > ul > li").removeClass("pageMenuHover");
    	$("[pageMenu="+menu+"]").addClass("pageMenuHover");
    	//切换内容页
    	$("[pagediv]").hide();
    	var pagediv = $("[pagediv="+menu+"]");
    	if(pagediv.length == 1){//这里做了判断,如果这个节点存在,就直接展示而不往下执行了,所以在我们自己写的js方法里就要移除这个节点.
    		pagediv.show();
    	}else{
    		$.post(root+"control/detailTab.php?type="+type+"&menu="+menu,{id:id},function(data){
    			if(data.warn){
    				warn(data.warn);
    			}else{
    				$("#pageMenu").after(data.html);
    			}
    		},"json");
    	}
    }
    ```

    

- 但是detailTab方法只能带这三个参数,要想点击按钮切换表格展示数据分类,那就得需要第四个参数,所以我们在自己写的js方法中带上这个状态参数workFlow.

- 进入js之后我们再把id和workFlow拼接,用一个符号隔开,再起名为id放到`detailTab()`方法的id参数上.到Class中我们写的分页代码方法里,再用`$data['post']`拿到`$data['post']['id']`,使用`explode()`函数分割为两个字符串,前一个为id,后一个为workFlow.

  ```js
  /**********切换审核列表**********/
  function changeMenu(e,type,menu,id,workFlow) {
      $("[pagediv="+menu+"]").remove();
      id = id+'-'+workFlow;
      detailTab(type,menu,id);
  }
  ```

- 这样相当于每次点击按钮都是切换tab,会刷新,所以按钮样式的改变也不能通过js方法,要在php代码里解决.

- 所以就拿我们截断的字符串里的workFlow作为判断条件,在三个按钮上分别加上选中样式即可.

  ```php
  if($thing[1]==""||$thing[1]=="全部"){
              $edit .="<div style='margin: 12px;'>
                      <span class='bigSpan choice' onclick=\"changeMenu(this,'driver','money','$driverId','全部')\">全部</span>
                      <span class='bigSpan' onclick=\"changeMenu(this,'driver','money','$driverId','提现支出')\">提现支出</span>
                      <span class='bigSpan'  onclick=\"changeMenu(this,'driver','money','$driverId','车费划分')\">车费划分</span>
                  </div>";
              $moneyCount = sqlQueryAll("select w.money as money,'提现支出' as type,w.updateTime as time from withdraw as w where w.driverId = '{$driver['id']}'
                          union all
                          select b.money*d.postRadio as money,'车费划分' as type,b.updateTime as time from buyCar as b
                          left join journey as j on b.journeyId = j.id
                          left join driver as d on j.driverId = d.id where d.isPostMoney != '' and b.workFlow = '已完成' and d.id = '{$driver['id']}'");
          }elseif ($thing[1]=="提现支出"){
              $edit .="<div style='margin: 12px;'>
                      <span class='bigSpan' onclick=\"changeMenu(this,'driver','money','$driverId','全部')\">全部</span>
                      <span class='bigSpan choice' onclick=\"changeMenu(this,'driver','money','$driverId','提现支出')\">提现支出</span>
                      <span class='bigSpan'  onclick=\"changeMenu(this,'driver','money','$driverId','车费划分')\">车费划分</span>
                  </div>";
              $moneyCount = sqlQueryAll("select w.money as money,'提现支出' as type,w.updateTime as time from withdraw as w where w.driverId = '{$driver['id']}'");
          }else{
              $edit .="<div style='margin: 12px;'>
                      <span class='bigSpan' onclick=\"changeMenu(this,'driver','money','$driverId','全部')\">全部</span>
                      <span class='bigSpan' onclick=\"changeMenu(this,'driver','money','$driverId','提现支出')\">提现支出</span>
                      <span class='bigSpan choice'  onclick=\"changeMenu(this,'driver','money','$driverId','车费划分')\">车费划分</span>
                  </div>";
              $moneyCount = sqlQueryAll("select b.money*d.postRadio as money,'车费划分' as type,b.updateTime as time from buyCar as b
                          left join journey as j on b.journeyId = j.id
                          left join driver as d on j.driverId = d.id where d.isPostMoney != '' and b.workFlow = '已完成' and d.id = '{$driver['id']}'");
          }
  ```

## 数组

- 如果你想**把一个数组中的某个值删除掉**,然后得到删掉这个值的新数组,那你需要使用**array_filp方法**,这个方法相当于你把数组的**键值对倒换**,然后你就可以通过你知道的那个想删除掉的值,也就是颠倒后的键获取到它在这个数组中的键,也就是颠倒后的数组中的值.

- 然后使用unset方法,把这个数组带着键放进去,就可以删除掉这个数组中的你想删掉的那个元素,你的数组也就得到了更新.

- ```php
  $a = array_flip($tagArr); //颠倒那个我们想删掉某个元素的数组
             $key = $a[$id];	//然后这个$id就是我们知道的那个值,但我们不知道这个值在数组中的键,现在这个颠倒后的数组,就可以拿$id作为键,获取它的值,这个获取到的值,就是原先数组中我们想删掉的那个元素的键
             unset($tagArr[$key]); //然后使用unset方法,删掉数组中键为我们获取到的键的那个元素,数组也完成了更新
  ```

- 但是这样会有个问题,删除掉某个元素的一维数组就不再是普通的一位数组了,存到数据库就会出问题,必须再使用一个方法把**一维数组重新排序**.也就是**array_values**方法

- ```php
  array_values($tagArr)  //这个方法可以让一维数组重新排序成键为0,1,2,3的一维数组
  ```

------



## 上传文件

- **上传文件**部分的代码在后端**异步处理**的时候,**接收到的文件**$file不是随便得到的,这个`$file=$_FILES["file"]`得到的$file是怎么来的呢?**方括号中的"file"**就是在前端**隐藏的上传input标签的name**,你给这个隐藏的上传文件标签的name起什么名字,后端就拿到的是哪个文件.

- ```php
  //类文件中的处理数据方法
  public function adTagEditData($data){
          $url = "file/".date("Ym");
          if(!file_exists(serverRoot.$url)){
              mkdir(serverRoot.$url);
          }
  
          $max_file_size=200000000;     //上传文件大小限制, 单位BYTE
  
          $file=$_FILES["file"];  //此处方括号中的字符串就是前端input文件上传标签的name属性的值
  //        $fileName=$file["name"];
          $filetype = $file["type"];
          $filesize = $file["size"];
  ```

- ```php
  //detailPara.php中写的页面部分 
  $para['tr'] = array(
                  array("标签"),
                  array(
                      //这里标签图片的部分中,第一个input标签就是隐藏了的上传文件标签,它的name属性的值就是后端异步处理数据时,想拿到这个上传的文件所必需的,$file=$_FILES["file"]这样才能拿到上传的文件的各种属性,而方括号中的字符串就是隐藏的上传文件标签的name属性
                      "标签名称：" => text(array("name" => "tagName","value" => $adTag['tagName'])),
                      "标签图片：" => "<input name=\"file\" type=\"file\" id=\"file\" onchange='preview(this)' style='display: none'>
                                  <img src='$img' id=\"yulan\">
                                  <img src='$logo' onclick='uploadImg()'>"
                  ,
                  ),
  ```

------

- 异步处理上传文件时,不要把上传写在方法最上面,因为这样的话在底下更新数据,很有可能出现上传成功但是更新失败的情况,这样的话文件上传了,数据却更新失败,那么文件就成了废文件.

- 所以我们应该在返回插入/更新数据成功信息后,再进行上传操作,不过因为上面的数据更新或插入时拿不到图片url,就必须在下面上传完毕后,再把url使用update语句更新到刚才那条数据中.

- 这里就必须使用`mysqli_insert_id($con)`方法,使用这个方法可以得到上一步执行的SQL语句得到的id,所以在上面的插入语句insert就是用这个方法拿id,然后更新url数据的.

- 不过这里的上传还是没封装上传方法之前的,很臃肿.

- ```php
  public function adTagEditData($data){
       //赋值
       $field = array(
           "tagName" => $data['post']['tagName'],//标签名称
  //            "imgUrl" => $dir,//标签图片url    这里因为不是先上传,自然也就拿不到url.
              "text" => $data['post']['text'],//备注
          );
          $adTag = query("adTag"," id = '".$data['post']['id']."' ");
          //判断
          if(!power("adTag","edit")){
              $json['warn'] = "您没有编辑标签的权限";
          }elseif(empty($field['tagName'])){
              $json['warn'] = "请填写标签名称";
          }
          //如果数据库中没这个id说明需要新建,用insert语句
          elseif(empty($adTag['id'])){
              $field["id"] = $data['post']['id'];
              $json['warn'] = insert(array("table" => "adTag","field" => $field));
          }
          //否则就代表数据库里有这个id,则是更新,使用update语句
          else{
              $json['warn'] = update(array("table" => "adTag","field" => $field,"where" => "id = '".$data['post']['id']."'"));
          }
          if(in_array($json['warn'],array("新增成功","更新成功"))){
              //上传文件搬到这里,防止上传成功更新却失败的情况
              $url = "file/".date("Ym");
              if(!file_exists(serverRoot.$url)){
                  mkdir(serverRoot.$url);
              }
  
              $max_file_size=200000000;     //上传文件大小限制, 单位BYTE
  
              $file=$_FILES["file"];
              $filetype = $file["type"];
              $filesize = $file["size"];
  
              $base64 = new base64_file("img");
              $expandedName = $base64->mime($filetype);
              $typeJudge = typeFile($filetype);  // 文件类型判断
  
              //$typeJudge['warn']为空意味着typeFile方法没有传递错误信息,说明文件格式没问题
              //格式没问题才考虑判断大小,文件是否存在
              if(empty($typeJudge['warn'])){
                  if($filesize > $max_file_size){                // 文件大小判断
                      $json['warn'] = "文件太大!";
                      exit;
                  }
  
  
                  $src = $url."/".suiji().".".$expandedName;
  
                  $filename = iconv("UTF-8","gb2312",serverRoot.$src);
                  //当文件存在
                  if (file_exists($filename)) {
                      //echo $fileName." already exists.";
                      $json['warn'] = $filename."文件存在";
  
                      $dir = $src;
  
                  }else{//当文件不存在
                      move_uploaded_file($_FILES["file"]["tmp_name"],$filename);
                      $dir = $src;
                  }
              }
  
              //将图片url更新进之前的那条数据里
              $field = array(
              "imgUrl" => $dir,//标签图片url
              );
              //拿到全局变量中的数据库连接con
              $con = $GLOBALS['con'];
              //mysqli_insert_id这个方法可以拿到上传前的更新或插入语句的那条数据的id,就用这个id来把上传完毕的url更新到那条数据中
              $successId = mysqli_insert_id($con);  
              update(array("table" => "adTag","field" => $field,"where" => "id = '".$successId."'"));
  
  
              //添加日志
              $type = mb_substr($json['warn'],0,2,'utf-8');
              $text = $data['control']['adName'].$type."了一个标签：".$field['tagName'];
              logText(array("type" => "adTag","text" => $text));
              //返回
              $_SESSION['warn'] = $json['warn'];
              $json['warn'] = 2;
          }
          $json['href'] = root."control/detail.php?type=adTag&id=".$data['post']['id'];
          return $json;
      }
  ```

------

- **最好的上传**就应该在extend中定义一个方法,传标签name给这个方法,方法返回一个url地址拿来用即可,这个url可以直接存进数据库.但是要注意,上传文件的操作应该放在更新数据之后,先更新除图片URL之外的数据,全都更新完,再上传,拿到上传图片URL,更新到刚才那条数据中去,防止更新数据失败上传却成功堆积垃圾文件的情况.

  ```php
  //extend.php文件中封装的上传方法
  function ThemeUpload($name){
      $url = "file/".date("Ym");
      if(!file_exists(serverRoot.$url)){
          mkdir(serverRoot.$url);
      }
  
      $max_file_size=200000000;     //上传文件大小限制, 单位BYTE
  
      $file=$_FILES[$name];
      $filetype = $file["type"];
      $filesize = $file["size"];
  
      $base64 = new base64_file("img");
      $expandedName = $base64->mime($filetype);
      $typeJudge = typeFile($filetype);  // 文件类型判断
  
      //$typeJudge['warn']为空意味着typeFile方法没有传递错误信息,说明文件格式没问题
      //格式没问题才考虑判断大小,文件是否存在
      if(empty($typeJudge['warn'])){
          if($filesize > $max_file_size){                // 文件大小判断
              $json['warn'] = "文件太大!";
              exit;
          }
  
  
          $src = $url."/".suiji().".".$expandedName;
  
          $filename = iconv("UTF-8","gb2312",serverRoot.$src);
          //当文件存在
          if (file_exists($filename)) {
              //echo $fileName." already exists.";
              $json['warn'] = $filename."文件存在";
  
              $dir = $src;
  
          }else{//当文件不存在
              $chenggong = move_uploaded_file($_FILES[$name]["tmp_name"],$filename);
              $dir = $src;
          }
  
  
          return $dir;
      }
  }
  ```

  ```php
  //Class文件中上传部分的代码
  if(in_array($json['warn'],array("新增成功","更新成功"))){
              //上传文件搬到这里,防止上传成功更新却失败的情况
              //ThemeUpload是封装在extend.php中的方法
              if($_FILES["file"]['name']){
                  $name = "file";
                  $dir = ThemeUpload($name);
              }
              //将图片url更新进之前的那条数据里
              $field = array(
              "imgUrl" => $dir,//标签图片url
              );
              //拿到全局变量中的数据库连接con
              $con = $GLOBALS['con'];
              $successId = mysqli_insert_id($con);
              update(array("table" => "adTag","field" => $field,"where" => "id = '".$successId."'"));
  
  
              //添加日志
              $type = mb_substr($json['warn'],0,2,'utf-8');
              $text = $data['control']['adName'].$type."了一个标签：".$field['tagName'];
              logText(array("type" => "adTag","text" => $text));
              //返回
              $_SESSION['warn'] = $json['warn'];
              $json['warn'] = 2;
          }
  ```

------

- 使用**unlink**方法可以**删除上传的文件**.

---

- 如果想要点击上传立刻上传并进行数据库操作,就必须给自己写好的表格加上一个form,然后进入`post.php`去进行数据操作.

  ```php
  $html = space."<h3>图片配置</h3>"."<style>.tableMany td{background-color: white!important;
      text-align: center!important;}.tableMany tr:hover {color: #555!important;}</style>".
      "<form  name='shopPicForm' method='post' enctype='multipart/form-data' action='".root."control/post.php?type=shopPicUpload'>"."<input name='shopId' value='$shopId' style='display: none' />".tableMany(array("tr" => $tr))."</form>";//这里的form就是我们要写的,name可以自己定
  ```

- 前面上传按钮部分,要加一个点击事件,触发form表单

  ```php
  for ($x=0;$x<5;$x++){
      //onchange='document.shopPicForm.submit()' 就是这个事件
      $up = "<input name=\"file".$x."\" type=\"file\" id=\"file".$x."\"  onchange='document.shopPicForm.submit()' style='display: none'>
  <span class='spanButton' onclick='uploadImg(this)' id='".$x."'>上传</span>"
          ;
      if(empty($shopPic[$x])){
          $tr[] = array('','','',$up);
      }else{
          $img = root.$shopPic[$x]["url"];
          $tr[] = array($shopPic[$x]['id'],$shopPic[$x]['name'],"<img style='width: 40px;height: 40px' src='$img' />",$up);
      }
  }
  ```

- 然后跑到`post.php`中去进行数据操作

  ```php
  /************门店小程序图片配置***************/
  elseif($get['type'] == "shopPicUpload") {
      if($_FILES["file0"]['name']){    //缩略图
          $name = "file0";
          $dir = ThemeUpload($name);
          $sequece = 1;
      }
      if($_FILES["file1"]['name']){//详情图1
          $name = "file1";
          $dir = ThemeUpload($name);
          $sequece = 2;
      }
      if($_FILES["file2"]['name']){//详情图2
          $name = "file2";
          $dir = ThemeUpload($name);
          $sequece = 3;
      }
      if($_FILES["file3"]['name']){//详情图3
          $name = "file3";
          $dir = ThemeUpload($name);
          $sequece = 4;
      }
      if($_FILES["file4"]['name']){//详情图3
          $name = "file4";
          $dir = ThemeUpload($name);
          $sequece = 5;
      }
      //将图片url更新进之前的那条数据里
      if($sequece==5){
          $field = array(
              "shopId" => $post['shopId'],
              "name" => '封面图',
              "sequence" => $sequece,
              "url" => $dir,//标签图片url
              "time" => $time,//标签图片url
              "updateTime" => $time,//标签图片url
          );
      }else{
          $field = array(
              "shopId" => $post['shopId'],
              "name" => '轮播图'.$sequece,
              "sequence" => $sequece,
              "url" => $dir,//标签图片url
              "time" => $time,//标签图片url
              "updateTime" => $time,//标签图片url
          );
      }
      $pic = sqlQueryAll("select * from shopPic where shopId = '{$post['shopId']}'"); //用上一条执行的SQL语句的id查询详情图表
      if(!empty($pic)){     //如果能从详情图表用themeId查出记录来,那就说明这条记录之前有,现在是在更新
          $ids = array();  //创建一个数组用来接收每个详情图的id
          foreach ($pic as $picId){  //把每条记录的id收集器来,存到数组$ids中
              $ids[] = $picId['id'];
          }
      }
      $updateID = array();
      if($sequece){  //如果数组中有数字,说明更新图片了
          test("进入更新顺寻判断,顺序=".$sequece);
          if(count($ids)>0){  //如果$ids不为空,就代表是更新,才会往下执行
              test("进入ids不为空判断");
              foreach ($ids as $shopPicId){  //遍历每个详情图id
                  $shopPic = query("shopPic","id = '$shopPicId'");  //循环每次赋值都会覆盖掉,只要不是追加数组就不怕数据堆积
                  test("查询出的图片顺序=".$shopPic['sequence']."图片id=".$shopPicId);
                  if ($shopPic['sequence']==$sequece){  //如果相同主题id查出来的几条详情图数据中有一条的顺序字段和我们判断的这个顺序重复
                      //                    mysqli_query($con, " delete from shopPic where id = '$shopPicId[id]' ");  //先删掉这条数据
                      test("进入顺序相同判断");
                      unlink(serverRoot.$shopPicId['url']);  //然后就删掉这个顺序的旧图片
                      $updateID[] = $shopPicId;
                  }
              }
          }
      }
      test("更新ID=".$updateID[0]);
      //如果$updateArr数组中有元素说明是图片更新
      if(count($updateID)>0){
          unset($field['time']);
          update(array("table" => "shopPic","field" => $field,"where"=>"id = '$updateID[0]'"));
      }
      //否则是新增
      else{
          $field['id'] = suiji();
          insert(array("table" => "shopPic", "field" => $field));
      }
      //post页面的跳转要这样写
      $locationUrl = root."control/detail.php?type=shop&menu=config&id=".$post['shopId'];
  
  }
  ```

------

- 上传图片(详情页包含其他输入信息,点击提交再一起上传)

- 首先在detailPara中写好上传表格

  ```php
  $tr[] = array("图片名称","预览","操作");
          //不知道要怎样拿到按钮传过来的id
          //拿到全局变量中的数据库连接con
          //用get拿到id
          $commodityPic = sqlQueryAll("select * from commodityPic where commodityId = '{$commodity['id']}' order by sequence");
          for ($x=0;$x<4;$x++){
              //previewCommodityPic是详情页表格显示版本的预览JS方法
              //uploadImg是通用上传JS方法
              $up = "<input name=\"file".$x."\" type=\"file\" id=\"file".$x."\"  onchange='previewCommodityPic(this)' num='$x'   style='display: none'>
  <span class='spanButton' onclick='uploadImg(this)' id='".$x."'>上传</span>";
  if(empty($commodityPic[$x])){
     $tr[] = array('','<img src=\'\' id="yulan">',$up);//在没图片的时候,表格中图片位置加上预览标签
  }else{
                  $img = root.$commodityPic[$x]["url"];
                  $tr[] = array($commodityPic[$x]['name'],"<img  id='yulan' style='width: 100px;height: 100px' src='$img' />",$up);//给表格中图片显示标签加上yulan类,方便js预览方法生效
              }
          }
          $html = space."<h3>图片配置</h3>"."<style>.tableMany td{background-color: white!important;
      text-align: center!important;}.tableMany tr:hover {color: #555!important;}</style>".
              tableMany(array("tr" => $tr));
  ```

  ```js
  //图片上传弹出框预览js
  function previewCommodityPic(a) {
      var file = a.files[0];
      if (window.FileReader) {
          var reader = new FileReader();
          reader.readAsDataURL(file);
          //监听文件读取结束后事件
          reader.onloadend = function (e) {
              //e.target.result就是最后的路径地址
              //这里因为把预览标签放到了表格里,节点变化,所以需要寻找父级节点来控制预览
              $(a).parent().parent().find("#yulan").attr("style", "width: 100px;height: 100px");
              $(a).parent().parent().find("#yulan").attr("src", e.target.result);
          };
      }
  }
  ```

  ```js
  //点击上传图片,触发真正上传按钮被点击事件
  function uploadImg(e) {
      // alert("#file"+$(e).attr("id"));
      if ($(e).attr("id") === "" || $(e).attr("id") == null) {
          $("#file").click();
      } else {
          i = $(e).attr("id");       // e.target表示被点击的目标
          id = "#file"+i;
          $(id).click();
      }
  }
  ```

- 然后在detailPara的最后一定要加上`$para['upload'] = 'upload'`

  ```php
  $para['tr'] = array(
              array(
                  "商品类型：" => $type,
                  must."商品名称：" => $commodityName,
              ),
              array(
                  "商品状态：" => select(array("name" => "workFlow",
                      "title" => "商品状态",
                      "value" => $commodity['workFlow'],
                      "option" => array("上架","下架"))),
  
                  must."单价：" => text(array("name" => "price","value" => $commodity['price'])),
              ),
              array(
                  must."伯爵币：" => text(array("name" => "earlCoin","value" => $commodity['earlCoin'])),
                  must."发行数量：" => text(array("name" => "publishNum","value" => $commodity['publishNum'])),
              ),
              array(
                  "商品描述：" => textarea(array("name" => "description","value" => $commodity['description'])),
              ),
              array(
                " " => $webPage,
              ),
              array("图片配置"),
              array(
                  " " => $html,
              )
          );
          $para['upload'] = "upload";
  ```

- 因为在`detail`中做了相应的判断,普通的详情页提交按钮,是不能提交上传文件的,我们重写了一个方法,做了一个新的标签,在需要提交上传文件的情况下替换掉相关的按钮.

  ```php
  /****基本资料新增和修改页面*************************************************/
      public function table($para){
          //如果有表单
          if(count($para['tr']) > 0){
              //表单提交
              //在这里做判断,某种情况下改变这里的$sub,让其不再引用subForm方法,而是使用自定义的js方法
              if(empty($para['sub'])){
                  if(!empty($para['upload'])){
                      //这里就是上传图片的新增详情页面自定义js方法的提交按钮
                      $sub = "upForm('".$para['type']."Form',root+'control/data.php?type=".$para['type']."Edit')";//upForm就是我们重写的
                  }else{
                      $sub = "subForm('".$para['type']."Form',root+'control/data.php?type=".$para['type']."Edit')";
                  }
              }else{
                  $sub = $para['sub'];
              }
              //生成表单
              if($para['type']=="adRoom"){  //如果是组队管理这个状态,就不生成button
                  $form = "
  			<form name='".$para['type']."Form'>
  				".tableEdit($para['tr'])."
  				<input name='id' type='hidden' value='".$para['id']."'>
  			</form>
  			";
              }else{  //否则就生成button
                  $form = "
  			<form name='".$para['type']."Form'>
  				".tableEdit($para['tr'])."
  				<input name='id' type='hidden' value='".$para['id']."'>
  				<div onclick=\"".$sub."\" class='formButton'>".$para['button']."</div>
  			</form>
  			";
              }
  
  
          }
          //生成页卡
          $html = "
  		<div class='pageDiv' pageDiv='edit'>
  			".$form.$para['other']."
  		</div>";
          //返回
          return $html;
      }
  ```

  ```js
  /********异步提交函数**************************/
  //图片上传版本js
  function upForm(form,url){
      // alert(form);
      //防止高频点击
      var date = new Date();
      var time = date.getTime();//毫秒时间戳
      if(typeof minTime == "undefined"){
          var finger = 2;
          minTime = time+2000;//下次点击的最小时间
          console.log("定义minTime");
      }else{
          if(minTime && time < minTime){
              var finger = 1;
              warn("操作过于频繁");
              console.log("time:"+time+"，mintime:"+minTime+"，差额："+(time-minTime));
          }else{
              var finger = 2;
              console.log("time:"+time+"，mintime:"+minTime+"，多出："+(time-minTime));
              minTime = time+2000;//下次点击的最小时间
          }
      }
      if(finger == 2){
          $(function(){
              var formData = new FormData($("[name='"+form+"']")[0]);
              console.log(formData.get('file'));
              $.ajax({
                  url: url,
                  type: 'POST',
                  cache: false,
                  data: formData,
                  // 告诉jQuery不要去处理发送的数据
                  processData: false,
                  // 告诉jQuery不要去设置Content-Type请求头
                  contentType: false,
                  beforeSend: function () {
                      console.log("正在进行，请稍候");
                  },
                  success: function (res) {
                      var data = JSON.parse(res);
                      if (data.warn == 2) {
                          if (data.href) {//如果异步返回的json参数中定义了重定向url，则跳转到本url
                              window.location.href = data.href;
                          } else {
                              window.location.reload();
                          }
                      } else {
                          warn(data.warn);
                      }
                  },
                  error: function (responseStr) {
                      console.log("error");
                  }
              });
  
          })
      }
  }
  
  ```

  

## 富文本编辑器

- 如果你要在网页中插入一个文本编辑器,可以插图片那种,这里目前在做的项目用的是`wangeditor`.

- 项目中是要往一个分支页中写编辑器,那就在Class文件中的tab方法里(因为这是第二个分支)写好页面,然后return这个页面.

  ```javascript
  public function tab($data){
          $themeId = $data['post']['id'];
          $theme = query("theme","id = $themeId");
          $webPage = "
                      <form name='wangEditorForm'>
                      <div id=\"editor\">
                         
                      </div>
                      <textarea id=\"text1\" name='imageText' style=\"display:none;width:100%; height:200px;\"></textarea>
                      <input name='themeId' value='$themeId' style='display: none' />
                      <div onclick=\"subForm('wangEditorForm',root+'control/data.php?type=adThemeStrategy')\" class=\"formButton\">提交</div>
                      </form>
                      <!-- 注意， 只需要引用 JS，无需引用任何 CSS ！！！-->
                      <script type=\"text/javascript\" src=\"".root."control/wangEditor.min.js\"></script>
                      <script type=\"text/javascript\">
                          var E = window.wangEditor
                          var editor = new E('#editor')
                          var text1 = $('#text1')
                          editor.customConfig.onchange = function (html) {
                              // 监控变化，同步更新到 textarea
                              text1.val(html)
                          }
                          // 或者 var editor = new E( document.getElementById('editor') )
                          // 配置服务器端地址
                          editor.customConfig.uploadImgServer = '/upload'
                          // 配置服务器端地址
                          editor.customConfig.customUploadImg = function (files, insert) {
                              // files 是 input 中选中的文件列表
                              // insert 是获取图片 url 后，插入到编辑器的方法
                              var formData = new FormData();
                              for(var i = 0;i<files.length;i++){
                                  formData.append(\"upfile[]\", files[i]);
                              }
                              $.ajax({
                                  url: root+\"control/data.php?type=createDir\",
                                  type: \"POST\",
                                  data:formData,
                                  cache:false,         //不设置缓存
                                  processData: false,  // 不处理数据
                                  contentType: false,   // 不设置内容类型
                                  success: function (res) {
                                      var data = JSON.parse(res);
                                      // 上传代码返回结果之后，将图片插入到编辑器中
                                      $.each(data.imgUrl,function(index,value){
                                          insert(value)
                                      });
                                  },
                                  error: function (responseStr) {
                                      console.log(\"error\");
                                  }
                              });
                          }
                          editor.create()           //创建文本编辑器
                          editor.txt.html('{$theme['imageText']}')  //回显编辑器输入提交的内容
                          // 初始化 textarea 的值
                          text1.val(editor.txt.html())
                      </script>
                      </html>
                      ";
          return $webPage;
      }
  ```

  - 数据处理的方法写在类中,在`data.php`注册.

  ```php
  /*******主题管理-主题管理-列表详情-攻略图文设置-异步处理******************************
       * $data = array(
       * "post" => "以post形式提交的参数",
       * "control" => "当前管理员参数",
       * );
       */
      public function adThemeStrategyData($data)
      {
  
          $themeId = $data['post']['themeId'];//主题id,拿到所有文本编辑器输入的内容存入主题表的对应字段
          //同一个主题可能有多个场次
          $theme = query("theme","id = '$themeId'");
          //判断
          if (!power("adTheme", "editRound")) {
              $json['warn'] = "您没有编辑图文攻略的权限";
          } elseif (empty($themeId) or $themeId == "") {
              $json['warn'] = "主题ID为空";
          } elseif (empty($theme['id'])) {
              $json['warn'] = "未找到此主题";
          }elseif (empty($data['post']['imageText'])) {
              $json['warn'] = "请输入攻略";
          } else {
              $imageText = $data['post']['imageText'];  //取出编辑器的图文
              $text = htmlspecialchars_decode($imageText);  //把预定义的 HTML 实体转换为字符。
                  update(array(
                      "table" => "theme",
                      "field" => array(
                          "imageText" => $text,//转换之后插入图文攻略
                      ),
                      "where" => "id = $themeId",
                  ));
                  //返回
                  $json['warn'] = 2;
                  $_SESSION['warn'] = "图文攻略更新成功";
              $json['href'] = root."control/detail.php?type=adTheme&id={$themeId}&menu=set";
              }
  
          return $json;
      }
  ```

## 表格

### 写死表格

- 显示固定的几行列表,就算没数据也展示,点击按钮可以新增对应那行的记录

- 原来有数据的行点击按钮可以更新记录.

  ```php
  $tr[] = array("会员等级","会员升级日期","操作");
  //不知道要怎样拿到按钮传过来的id
  //拿到全局变量中的数据库连接con
  //用get拿到id
  $userPointLevels = sqlQueryAll("select * from userPointLevel order by lowestPoint");
  $updateRecords = sqlQueryAll("select up.id,up.level,us.levelName,up.upgradeTime from updateRecord as up 
                                    left join userPointLevel as us on us.id = up.level 
                                    where up.khid = '{$kehu['khid']}'
                                     order by us.lowestPoint
                                    ");
  
  foreach ($userPointLevels as $userPointLevel){
      $upl[] = $userPointLevel['id'];
  }
  $userPointLevelNum = sqlNum("userPointLevel","1 = 1");
  for ($x=0;$x<$userPointLevelNum;$x++){
      $userId[] = $userPointLevels[$x]['id'];
      $upgradeLevel[] = $updateRecords[$x]['level'];
      if (in_array($updateRecords[$x]['level'],$upl)) {
          $mx = "<span onclick=\"layer('editRecord',{'id':'{$updateRecords[$x]['id']}','khid':'{$kehu['khid']}','levelId':'{$userPointLevels[$x]['id']}'})\" class='spanButton'>修改日期</span>\n";
          $tr[] = array($updateRecords[$x]['levelName'], $updateRecords[$x]['upgradeTime'], $mx);
      } else {
          $id = suiji();
          $mx = "<span onclick=\"layer('editRecord',{'id':'$id','khid':'{$kehu['khid']}','levelId':'{$userPointLevels[$x]['id']}'})\" class='spanButton'>修改日期</span>\n";
          $tr[] = array($userPointLevels[$x]['levelName'], '', $mx);
      }
  }
  
  
  
  //在这里也拼接一个隐藏的input标签,携带主题id过去,让我们在删除的异步方法里可以拿得到
  //这个$html就是我们主题管理列表详情的场次表格,放到下面的array("场次信息")之下
  //因为是插入的表格所以样式不规范,很难看,插入一个style改变样式即可
  $html = space."<style>.tableMany td{background-color: white!important;
      text-align: center!important;}.tableMany tr:hover {color: #555!important;}</style>". tableMany(array("tr" => $tr));
  ```


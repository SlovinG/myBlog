

## 下拉选择

- 如果想直接用数据库的数据做成一个下拉框用作搜索或者更新,就不能去para数据表里写死,就需要使用`idSelect`方法.

  ```php
  idSelect(array("sqlForm" => "userlevel order by id","sqlId" => "levelName","sqlField" => "levelName","name" => "levelId","title" => "会员等级")).
  
   //这样的写法就可以用作搜索框,但是其实可以被取代.
      
      
      
    must."会员卡等级：" =>idSelect(array("sqlForm" => "userlevel order by id","sqlId" => "levelName","sqlField" => "levelName","name" => "level","title" => "会员等级","value"=>$kehu['level'])),
  //这样写就是在详情页新增页新增或编辑数据时的下拉框,如果你要获取的不是id而是文字,就要把sqlId这个键对应的值写为你想要的文字在数据库中的字段名
  ```

------

## 二级联动

- 如果你想实现二级联动,就需要去`extend.js`中写方法

  ```js
  /*******订单管理-订单管理-详情-选择主题***********************************************/
  function selectTheme(obj) {
      $.post(root + "control/data.php?type=getReserveRound", {theme: obj.value}, function (data) {
          $("[name='roundId']").html(data.secondSelect);
      }, "json");
  }
  ```

  ```php
  array(
                  must."订单号：" => text(array("name" => "orderNumber","value" => $buyCar['orderNumber'])),
                  must."主题：" => idSelect(array("sqlForm" => "theme order by id","sqlId" => "id","sqlField" => "themeName","name" => "themeId","title" => "主题选择","change"=>"selectTheme","value" => $buyCar['themeId'])), //一级选择绑定js方法
              ),
              array(
                  must."预订人：" => text(array("name" => "userName","value" => $buyCar['reservation'])),
                  must."手机号：" => text(array("name" => "userTel","value" => $buyCar['reservationCall'])),
              ),
              array(
                  must."数量：" => text(array("name" => "number","value" => $buyCar['number'])),
                  must."金额：" => text(array("name" => "money","value" => $buyCar['money'])),
              ),
              array(
                  must."消耗次数：" => text(array("name" => "consumeCount","value" => $buyCar['consumeCount'])),
                  must."预定日期：" => text(array("name" => "presetTime","laydate" => array(),"value" => $buyCar['presetTime'])),
              ),
              array(
                  must."预定场次：" =>
                      idSelectTwo(array("sqlForm" => "round where themeId = '$buyCar[themeId]' order by id","sqlId" => "id","sqlField" => array("startTime","endTime"),"name" => "roundId","title" => "预定场次","value" => $round['id'])),//二级选择
                  must."订单状态：" => select(array("name" => "workFlow","title" => "选择","option" => array("待支付","待消费","已完成","退款中","已退款"),"value" => $buyCar['workFlow'])),
              ),
  ```

  ```php
  /************订单管理-订单管理-详情-选择主题********************************************/
  elseif($get['type'] == "getReserveRound") {
      $theme = query("theme","id = $post[theme]");
      $sqlForm = " round where themeId = '$theme[id]' order by id ";
      $json['secondSelect'] = idSelect(array("sqlForm" => $sqlForm,"sqlId" => "id","sqlField" => "startTime","name" => "roundId","title" => "预定场次"));
  }
  ```

------

- 在做**异步二级联动**的时候,如果是直接展示数据或者是联动展示到另外的下拉里,js方法中把异步的值通过html(data.得到的属性).

  ```js
  /*******采购-采购询价表-详情-物料名称二级联动***********************************************/
  function selectMaterial(obj) {
      $.post(root + "control/addata.php?type=getNumAndUnit", {product:obj.value}, function (data) {
          $("[name='specification']").html(data.specification);
          $("[name='unit']").html(data.unit);
      }, "json");
  }
  ```

------

- 如果是联动显示到二级输入框中,就需要使用val(data.得到的属性).

---

## 搜索

- 关于搜索功能的where部分,Class中会拼成一个$where数组,但是这个数组仅仅只是你放进去的查询条件,不包括SQL语句中的where关键字,所以如果要使用,必须在定义的SQL语句结尾先拼接where 1 = 1,然后再拼接$where才可以正常进行搜索查询.

## JSON数组关联它表删除

- 连带删除功能代码例子,假如有会员表,还有个标签表,标签以json形式绑定在会员表中的某个字段(一般是JSON格式),现在想删除标签表里的标签的同时把有这个标签的用户的这个标签也一起都删掉.

  ```php
  /**********************会员管理-会员标签列表-批量删除*********************************/
  elseif($get['type'] == "deleteTag") {
      $array = $post['id'];
      if (!power("adTag", "del")) {
          $json['warn'] = "您没有删除标签的权限";
      } elseif (empty($array)) {
          $json['warn'] = "您一个标签都没有选择呢";
      } else {
          $text = "";
          foreach ($array as $id) {
              $tag = sqlQueryAll("select * from kehu where tag like '%$id%'");//查询所有客户信息,然后遍历拿到客户的标签json,把遍历中的每个json转为数组,判断其中有没有我们要删除的标签id,如果有就删掉
  //            这里的代码完成删除标签时,自动删除所有带这个标签的会员的标签JSON中的这个标签
              if (!empty($tag)){
                  foreach($tag as $tagOne){
                      $tagArr = json_decode($tagOne['tag'],true);
                      $a = array_flip($tagArr);
                      $key = $a[$id];
                      //这里指定删除数组中值为我们要删除的那个标签的id
                      unset($tagArr[$key]);
                      if(empty($tagArr)){
                          update(array(
                              "table" => "kehu",
                              "field" => array(
                                  "tag" => "",//更新标签
                              ),
                              "where" => " khid = '$tagOne[khid]' ",
                          ));
                      }else{
                          $tagJson = json_encode(array_values($tagArr));
                          update(array(
                              "table" => "kehu",
                              "field" => array(
                                  "tag" => $tagJson,//更新标签
                              ),
                              "where" => " khid = '$tagOne[khid]' ",
                          ));
                      }
  
                  }
              }
  
  
  
              $adTag = query("adTag", " id = '$id' ");
              //最后删除客户基本参数
              mysqli_query($con, " delete from adTag where id = '$adTag[id]' ");
              unlink(serverRoot.$adTag['imgUrl']);
              //返回
              $warn = "删除成功";
              $x++;
  //            }
              $text .= "会员标签【" . $adTag['tagName'] . "】，会员标签ID【" . $adTag['id'] . "】" . $warn . "。<br>";
          }
          //添加日志
          $text = $control['adName'] . "批量删除了会员积分等级，结果如下：<br>" . $text;
          logText(array("type" => "adTag", "text" => $text));
          //返回
          $_SESSION['warn'] = "删除了" . $x . "个标签，详情见系统日志。";
          $json['warn'] = 2;
      }
  }
  ```

## CSS

### 覆盖CSS

- 如果你想要强行覆盖一些css样式,就需要往这段页面中插入css片段去覆盖,如以下代码

  ```css
  $html = $edit.space."<style>.tableMany td{background-color: white!important;
      text-align: center!important;}.tableMany tr:hover {color: #555!important;}</style>".tableMany(array("tr" => $tr))."<input name='themeId' style='display: none' value='$themeId' />";
  ```

---

- 如果你想改变弹出层其中的CSS样式,你首先要去浏览器F12中找到对应样式.

- 然后复制下来,修改其中你要修改的部分,

- 之后在Class中的Layer相关函数中,写好这部分样式

  ```php
  $result['css'] = 
          '.tableRight tr>:first-child {
          min-width: 0px;!important
          }';
  ```

- 这里我选择返回的是`$result['css']`,其实括号里的名字可以自定义.

- 然后去`layer.php`修改对应部分的代码,到使用到类的那部分代码里接收这个css

  ```php
  if(!empty($result['css'])){
              $html .= "<style>
              ".$result['css']."
              </style>";
          }
  ```

  ```php
  elseif($key = arrayTwoValue($data['type'],$this->typeClass)){
  
  
      require_once(serverRoot."class/".$key.".php");
      $class = new $key();
  
  
      $fun = $data['type']."Layer";
  
      $result = $class->$fun(array("post" => $post,"control" => $data['control']));
      $this->frame = array("title" => $result['title'],"height" => $result['height'],"width" => $result['width']);
      if(!empty($result['list'])){
          $html .= $this->tableList($result['list']);
      }
      if(!empty($result['auditingFollow'])){
          $html .= "<div class='recordDiv'><p class='center'>审核记录</p>".$this->auditingFollow($result['auditingFollow'])."</div>";
      }
      if(!empty($result['table'])){
          if(empty($result['hidden'])){
              $hidden = $idInput;
          }else{
              $hidden = $idInput.$result['hidden'];
          }
  
          if($data['type']!='adUserExport'){
              if(empty($result['button'])){
                  if(empty($result['formTwo'])){
                      $result['button'] = $this->button();
                  }else{
                      $result['button'] = $this->button(array("formTwo" => $result['formTwo']));
                  }
              }
          }
          //判断如果action不为空,就把button按钮替换为一个普通的submit按钮
          if(!empty($result['action'])){
              $result['button'] = "<input type=\"submit\" value=\"提交\" class='spanButton'/>";
          }
  
          $result['table'][$hidden] = $result['button'];
          $html .= $this->table($result['table'],$result['tables'],$result['action']);
      }
      $html .= $result['html'];
      //增加如果想传css样式就这样传
      if(!empty($result['css'])){
          $html .= "<style>
              ".$result['css']."
              </style>";
      }
  }else{
      $html = "未知弹出层执行指令";
  }
  //返回信息
  return $html;
  ```

- 这样就可以了,不过还有点问题,就是如果想要强制覆盖样式,一定要加`!important`,但是要注意是给具体样式加,不是给类选择器加.

  ```php
  $result['css'] = 
          '.tableRight tr>:first-child {
          min-width: 0px;!important//是加在这里的
          }';
  ```

- 同时呢还有一个问题,就是你加了`!important`之后也可能会出现点击弹出层内容不起作用的问题,打开F12发现相关样式前有一个黄色感叹号,说`unknown property name`.去stockoverflow找到对应原因如下:

> 在chrome控制台中，您可以看到在最后几个属性之前有4个看似错误编码的字符。它与4个空格缩进匹配。当您将代码粘贴到此处时，CSS文件中可能会有一些奇特的字符显示为空格。
>
> 您可以简单地尝试删除这些属性前面的缩进空格，看看是否可行？

- 意思就是去掉所有具体样式前的缩进和空格即可解决

### 行级样式

- CSS中的`float`会影响下一行的样式

- 下面介绍清除浮动的三个方式：

  **1.增加一个空的标签（div 或 br等都行），通过clear：both语句消除float对后面元素的影响。**

  ```html
  <div class="main_left">.main{float:left;}</div>
  <div class="side_left">.side{float:right;}</div>
  <!--增加一个空标签-->
  <div style="clear:both;"></div>
  <div class="footer">.footer</div>
  ```

  缺点：需要加很多无意义的标签，对后期维护不利。如果是小程序，那没关系，但如果是大工程，还是慎用。

  **2.使用:after 伪元素**

  ```css
  .clearIt { zoom:1; }
  .clearIt:before;  
   /*加上before可以防止浏览器顶部的空白崩溃（就是上一个div的margin-bottom和下边的margin-top会发生叠加）*/
   .clearIt:after {
      content:".";
      display:block; 
      height:0;
      visibility:hidden; 
      clear:both; 
  }
  /*
  display:block 使生成的元素以块级元素显示,占满剩余空间;
  height:0 避免生成内容破坏原有布局的高度。
  visibility:hidden 使生成的内容不可见，并允许可能被生成内容盖住的内容可以进行点击和交互;
  通过 content:"."生成内容作为最后一个元素，至于content里面是点还是其他都是可以的，例如oocss里面就有经典的 content:"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX",有些版本可能content 里面内容为空,一丝冰凉是不推荐这样做的,firefox直到7.0 content:”" 仍然会产生额外的空隙；
  zoom：1 触发IE hasLayout。
  */
  ```

  **3.在父元素设置 overflow：auto**

  ```html
  <!--为父元素设置overflow-->
  <div class="wrap"  style="overflow:auto;">
  <div class="wrap_main_left">.main{float:left;}</div>
  <div class="wrap_side_left">.side{float:right;}</div>
  </div>
  <div class="footer">.footer</div>
  ```

  ![img](https://img-blog.csdn.net/20181003155359802?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NlYXJjaGluX1I=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

  当父元素设置了overflow：auto之后，内容元素会被修剪，超出元素不可见。

  这种方式的优点是不存在结构和语义化问题，代码量极少。但缺点也很严重，当内容增多时容易因为不会自动换行而导致内容被隐藏掉，无法显示需要溢出的元素。

  **其实只有clear：both是用来消除float的影响。其它的几种方式都是通过隐藏内容来达到自己的目的。**

## 双击表格进入编辑页面

- 想完成双击表格中的一行,就触发和编辑按钮一样的效果,就需要去listReasult中的最下面的返回部分的代码中返回的那段html最后拼接上一组script标签.在其中写好jquery方法,代码如下:

  ```php
  if(!empty($tr)){
      if(empty($formName)){
          $formName = "listForm";
      }
      $json['html'] = $page['hint'].$button."<form name='".$formName."'>".space.tableMany(array("tr" => $tr,"text" => $tdText))."</form>".$page['button'].clear.
      "<style type=\"text/css\">
      input[type=\"checkbox\"]{
          zoom:180%;
          }
      </style>
      <script>
         $(function(){
  			$('tr').on('dblclick',function(){
  				if($(this).children().children().is('.spanButton')){
  				    $(this).children().children('.spanButton').click();
  				}
  			})
  		}) 
      </script>
      ";
  }
  ```

## 双击标签关闭页面

- 当你想实现双击导航标签就关闭这个标签对应的页面时,需要去`adIndex.php`中写好js代码,代码具体如下

  ```php
  $(document).on("dblclick",".iframeTitleNow",function(){
              if($(this).children().is('.iframeClose')){
                  $(this).children(".iframeClose").click();
              }
          });
  ```

## in查询(不建议使用)

- 如果你的页面查询中有不属于你这个表的字段,就需要使用SQL语句中的in关键字来查询.

- and后面跟的那个字段就是你当前表和你要查询的条件的字段的那张表的关联ID,之后in进入括号中的SQL语句之后,select 后面跟的字段就是这个外表和你当前表的关联字段对应的那个字段.因为你这两张表只有这两个字段可以用作联系.

  ```php
  if(!empty($data['post']['department'])||!empty($data['post']['twoDepartment'])||!empty($data['post']['dutyName'])){
              $and = "";
              if(!empty($data['post']['department'])){
                  $and .= "and adDutyId in (select id form adDuty where department = '$data[post]['department']')";
              }
              if(!empty($data['post']['twoDepartment'])){
                  $and .= "and adDutyId in (select id form adDuty where twoDepartment = '$data[post]['twoDepartment']')";
              }
              if(!empty($data['post']['dutyName'])){
                  $and .= "and adDutyId in (select id form adDuty where dutyName = '$data[post]['dutyName']')";
              }
          }
  ```

## 框架自带图片上传方法photo

- 框架里**自带的图片上传**有一个photo方法.如果要使用单个图片上传就用如下代码

  ```php
  elseif($get['type'] == "adAssets"){
      //定义参数
      if(empty($get['id'])){
          $para = array("id" => suiji(),"title" => "新增固定资产","button" => "新建");//基本参数
      }else{
          $assets = query("assets"," id = '$get[id]' ");
          if(empty($assets['id'])){
              $para['warn'] = "未找到此记录";
          }else{
              $menu = array("edit" => "基本信息","info" => "辅助信息");//菜单数组
              $para = array("id" => $assets['id'],"title" => $assets['name'],"button" => "更新","menu" => $menu);
              $para['other'] = photo(array(
                  array("title" => "实景图","url" => $assets['ico'],"type" => "assetsIco","id" => $assets['id']),
              ));
          }
      }
  ```

- 如果要一次上传多个就用如下代码

  ```php
    /****行政人事-员工管理-辅助信息********************************************/
  }elseif($get['type'] == "admin" and $get['menu'] == "info"){
      //数据库查询
      $admin = query("admin"," adid = '$post[id]' ");
      //数组
      $trData = array(
          array(
              "员工ID：" => $admin['adid'],
              "账户余额：" => "<span class='red'>￥".$admin['money']."</span>",
          ),
          array(
              "更新时间：" => $admin['updateTime'],
              "创建时间：" => $admin['time'],
          ),
      );
      $photo = array(
          array("title" => "头像","url" => $admin['touxiang']),
          array("title" => "身份证正面","url" => $admin['IDCardFront'],"type" => "IDCardFront","id" => $admin['adid']),
          array("title" => "身份证背面","url" => $admin['IDCardBack'],"type" => "IDCardBack","id" => $admin['adid']),
          array("title" => "毕业证","url" => $admin['diploma'],"type" => "diploma","id" => $admin['adid']),
          array("title" => "工资卡","url" => $admin['bankIco'],"type" => "bankIco","id" => $admin['adid']),
      );
      $html = tableEdit($trData).photo($photo);
      /****行政人事-员工管理-工作经历********************************************/
  ```

------

- 使用框架带的那个photo方法上传图片,在post里写方法时,要注意,**上传图片的文件夹你不能随便写**,因为你写了新的文件夹因为没有权限,就不会创建成功,上传文件也就失败了

  ```php
  $data = array(
              "fileName" => "file",//上传图片的表单文件域名称
              "sqlSearch" => " select * from admin where adid = '$id' ",//查询图片的数据库代码
              "make" => "缩放图像",//处理方式：裁剪图像、缩放图像、空
              "type" => "更新图像",//插入类型：更新图像、新增图像
              "field" => "picture",//存放图片根目录的数据库字段名
              "url" => "img/touxiang/".suiji().".jpg",//新图片保存的网站根目录位置,这里的touxiang就是文件夹名
              "maxNum" => "",//新增图像时限定的图像总数
              "newWidth" => 1000,//新图像的宽度
              "newHeight" => "",//新图像的高度
              "maxHeight" => 4000,//缩放后图片的最大高度
          );
  ```

## 区域联动

- 如果一个页面需要出现两个区域联动,这时候是不行的,因为它们在一个表单里,重名了,只能有一个.

- 如果一定要放两个,那就在主form外再连一个小form,把第二个区域联动放进去,这样就可以完成一个页面两个区域联动.

  ```php
  public function tab($data){
  //定义参数
          $id = $data['post']['id'];
  
              $admin = query("admin", " adid = '$id' ");
  
  
              if (empty($admin['adid'])) {
                  $para['warn'] = "未找到此员工";
              } else {
                  $button = "更新";
              }
  		//第一个区域联动
          $trData = array(
              array(
                  must."性别：" => select(array("name" => "sex","title" => "选择性别","option" => explode(",",para("sex")),"value" => $admin['sex'])),
                  "生日：" => text(array("name" => "birthday","laydate" => array(),"title" => "生日","value" => $admin['birthday'])),
              ),
              array(
                  must."年龄：" => text(array("name" => "age","value" => $admin['age'])),
                  "民族：" => text(array("name" => "nationality","value" => $admin['nationality'])),
              ),
              array(
                  must."户口性质：" => text(array("name" => "residence","value" => $admin['residence'])),
                  "婚否：" => select(array("name" => "isMarry","title" => "婚否","option" => explode(",",para("isMarry")),"value" => $admin['isMarry'])),
              ),
              array(
                  "生育：" => select(array("name" => "hasChild","title" => "生育与否","option" => explode(",",para("hasChild")),"value" => $admin['hasChild'])),
                  "政治面貌：" => select(array("name" => "politicsStatus","title" => "生育与否","option" => explode(",",para("politicsStatus")),"value" => $admin['politicsStatus'])),
              ),
              array(
                  "档案地址：" => text(array("name" => "fileAddress","value" => $admin['fileAddress'])),
                  "学历：" => select(array("name" => "educationalBackground","title" => "学历","option" => explode(",",para("educationalBackground")),"value" => $admin['educationalBackground'])),
                  ),
              array(
                  must."毕业学校：" => text(array("name" => "school","value" => $admin['school'])),
                  "专业：" => text(array("name" => "schoolMajor","value" => $admin['schoolMajor'])),
                  ),
              array(
                  "证书：" => text(array("name" => "certificate","value" => $admin['certificate'])),
                  "电子邮箱：" => text(array("name" => "email","value" => $admin['email'])),
              ),
              array(
                  "联系电话：" => text(array("name" => "adtel","value" => $admin['adtel'])),
                  "身份证号：" => text(array("name" => "IDCard","value" => $admin['IDCard'])),
              ),
              array(
                  "身份证居住地址：" => regionSelect('adminPersonalForm',$admin['IDCardRegionId']).
                      text(array("name" => "IDCardAddress","value" => $admin['IDCardAddress'])),
              ),
              array(
                  "工资卡号：" => text(array("name" => "bankNum","value" => $admin['bankNum'])),
                  "开户行：" => text(array("name" => "bankName","value" => $admin['bankName'])),
              ),
              array(
                  "紧急联系人：" => text(array("name" => "urgencyContact","value" => $admin['urgencyContact'])),
                  "紧急联系人电话：" => text(array("name" => "urgencyPhone","value" => $admin['urgencyPhone'])),
              ),
          );
      //第二个区域联动
  $trDataTwo = array(
                  array(
                      "现居住地址：" => regionSelectTwo('adminPersonalTwoForm',$admin['liveRegionId']).
                          text(array("name" => "liveAddress","value" => $admin['liveAddress'])),
                  ),
              );
          $photo = array(
              //头像字段用作员工照片,身份证正面字段用作证件照片
              array("title" => "员工照片","url" => $admin['picture'],"type" => "picture","id" => $admin['adid']),
              array("title" => "身份证","url" => $admin['IDCardFront'],"type" => "IDCardFront","id" => $admin['adid']),
          );
          ;
      //adminPersonalForm是第一个form,adminPersonalTwoForm是第二个.
          $html = "<form name='adminPersonalForm'>".tableEdit($trData).
              "</form>"."<form name='adminPersonalTwoForm'>".tableEdit($trDataTwo)."</form>".photo($photo)."<div onclick=\"subForm('adminPersonalForm,adminPersonalTwoForm',root+'control/data.php?type=adminPersonalEdit')\" class='formButton'>".$button."</div>";
          return $html;
  ```

------

## 时间选择框

- 当详情页或分支页有时间选择器时,有时会出现bug,当查询出的时间为空,时间选择器就会默认选中0100-00-00,其实这时数据库存的数据为0000-00-00.

- 这样子每次选时间都要清空再选非常麻烦,如何解决呢?如果你页面中只有一个时间选择器,那就用if/else解决.

- 如果你一个页面中有很多个,那就可以用三元运算符来解决,会看起来整齐的多,也不会太多行代码.

  ```php
    //只有一个时间选择
  		if($admin['entryTime']=='0000-00-00'){
              $entryTime='';
          }else{
              $entryTime=$admin['entryTime'];
          }
  ```

  ```php
  //有多个时间选择,使用三元
  $admin['entryTime']=='0000-00-00'?$entryTime='':$entryTime=$admin['entryTime'];
  $admin['officialTime']=='0000-00-00'?$officialTime='':$officialTime=$admin['officialTime'];
  $admin['changeSalaryTime']=='0000-00-00'?$changeSalaryTime='':$changeSalaryTime=$admin['changeSalaryTime'];
  $admin['endSalaryTime']=='0000-00-00'?$endSalaryTime='':$endSalaryTime=$admin['endSalaryTime'];
  $admin['contractStartDate']=='0000-00-00'?$contractStartDate='':$contractStartDate=$admin['contractStartDate'];
  $admin['signContractDate']=='0000-00-00'?$signContractDate='':$signContractDate=$admin['signContractDate'];
  $admin['endContractDate']=='0000-00-00'?$endContractDate='':$endContractDate=$admin['endContractDate'];
  $admin['quitTime']=='0000-00-00'?$quitTime='':$quitTime=$admin['quitTime'];
  ```

---

- 范围选择日期

- 因为-符号已经是年月日的分隔符号了,所以使用~~分割时间

  ```php
  text(array("name" => "time","laydate" => array("range"=>"~"),"title" => "日期选择")).
  ```

- 插入`$sql`中的判断语句就这样生成

  ```php
  if(!empty($data['post']['time'])){
              $timeArr = explode("~",$data['post']['time']);
              $oneTime = trim($timeArr[0]);
              $twoTime = trim($timeArr[1]);
              $time = "and a.time between '$oneTime' and '$twoTime'";
          }
  ```

  

## 输入框

- 如果有些int类型的数据输入框,当你这个字段为0时,页面上输入框中会不显示任何数字,要想解决这个问题,就需要去entend.php中写一个可以显示0的输入框方法textZero,在生成输入框时是用这个方法即可.

  ```php
  /**********生成可以显示0的单行文本框********************************************************/
  /*
  $data = array(
  	"name" => "文本框name",
  	"id" => "文本框id",
  	"laydate" => array()//"调用laydate日历框架，数组内可以放一些额外参数",
  	"title" => "文本框标题",
  	"value" => "文本框value",
  	"class" => "文本框的class",
  	"click" => "鼠标点击事件函数名",
  	"blur" => "元素失去焦点事件函数名",
  	"keyup" => "某个键盘按键被松开时的函数名",
  	"other" => "串联其他属性",
  );
  */
  function textZero($data){
      $attribute = $js = "";
      if(!empty($data['id'])){
          $attribute .= " id='".$data['id']."' ";
      }elseif(array_key_exists("laydate",$data)){//如果存在laydate键名
          $id = suiji();
          $attribute .= " id='".$id."' ";
          $json = "";
          foreach((array)$data['laydate'] as $key => $value){
              $json = ",".$key.":'".$value."'";
          }
          $js = "<script>$(function(){laydate.render({elem:'#".$id."'".$json."});});</script>";
      }
      if(!empty($data['title'])){
          $attribute .= "  placeholder='".$data['title']."' title='".$data['title']."' ";
      }
      if(!empty($data['class'])){
          $attribute .= " class='".$data['class']."' ";
      }
      if(!empty($data['click'])){
          $attribute .= " onclick='".$data['click']."(this)' ";
      }
      $attribute .= " value='".$data['value']."' ";
      if(!empty($data['blur'])){
          $attribute .= " onblur='".$data['blur']."(this)' ";
      }
      if(!empty($data['keyup'])){
          $attribute .= " onkeyup='".$data['keyup']."(this)' ";
      }
      $html = "<input type='text' name='".$data['name']."' ".$attribute.$data['other'].">".$js."\n";
      return $html;
  }
  ```
## 时间计算

### 月份差额

- 如果想获得两个**时间的月差额**,就需要以下的方法

  ```php
  function getMonthNum( $date1, $date2, $tags='-' ){    $date1 = explode($tags,$date1);    $date2 = explode($tags,$date2);    return abs($date1[0] - $date2[0]) * 12 + abs($date1[1] - $date2[1]);}
  ```

---

## 时间比较与计算

- php给时间(年月日时分秒)加时间(天,小时,月)

  ```php
  // 当前时间戳  格式：2019-03-13 18:00:00
  echo date('Y-m-d H:i:s', strtotime('now'));
   
  // 当前时间戳+1秒
  echo date('Y-m-d H:i:s', strtotime('+1second'));
   
  // 当前时间戳+1分
  echo date('Y-m-d H:i:s', strtotime('+1minute'));
   
  // 当前时间戳+1小时
  echo date('Y-m-d H:i:s', strtotime('+1hour'));
   
  // 当前时间戳+1天 
  echo date('Y-m-d H:i:s', strtotime('+1day'));
   
  // 当前时间戳+1周 
  echo date('Y-m-d H:i:s', strtotime('+1week'));
   
  // 当前时间戳+1月 
  echo date('Y-m-d H:i:s', strtotime('+1month'));
   
  // 当前时间戳+1年
  echo date('Y-m-d H:i:s', strtotime('+1year'));
   
  // 当前时间戳+12年，12月，12天，12小时，12分，12秒
  echo date('Y-m-d H:i:s', strtotime('+12year 12month 12day 12hour 12minute 12second'));
   
  $t = 1483967416; // 指定时间戳
   
  echo $date = date('Y-m-d H:i:s', $t);
   
  /*方法一*/
   
  // 指定时间戳+1天
  echo date('Y-m-d H:i:s', $t+1*24*60*60);
   
  // 指定时间戳+1年
  echo date('Y-m-d H:i:s', $t+365*24*60*60);
   
  /*方法二*/
   
  //$t是指定时间戳
   
  // 指定时间戳+1天
  echo date('Y-m-d H:i:s', strtotime("+1day", $t));
   
  // 指定时间戳+1年
  echo date('Y-m-d H:i:s', strtotime("+1year", $t));
  
  ```

- php中如果想对比两个时间比如` 2019-10-30 11:44:03`这种,那就需要先用`strtotime()`方法将时间放进去再进行对比,用大于小于号对比即可.

  ```php
  strtotime($resultTime)<strtotime($date)
  ```



## 事务

- PHP事务操作

  ```php
  mysqli_autocommit($con,false);//表示事务开始
  $update = update(array("table" => "salary", "field" => $field, "where" => "id = '" . $data['post']['id'] . "'"));//编辑字段更新
  $computeUpdate = update(array("table" => "salary", "field" => $computeField, "where" => "id = '" . $data['post']['id'] . "'"));//算法字段更新
  
              if($update == "更新成功"&&$computeUpdate == "更新成功"){
                  mysqli_commit($con); //成功即提交
                  $json['warn'] = $update;
              }else{
                  mysqli_rollback($con);
                  $json['warn'] = $update;
                  $json['warn'] = $computeUpdate;
              }
              mysqli_autocommit($con,true);//表示事务结束
  ```

## API接口

- 调用他人API接口函数

  ```php
  /**
   * [http 调用接口函数]
   * @Date   2016-07-11
   * @Author GeorgeHao
   * @param  string       $url     [接口地址]
   * @param  array        $params  [数组]
   * @param  string       $method  [GET\POST\DELETE\PUT]
   * @param  array        $header  [HTTP头信息]
   * @param  integer      $timeout [超时时间]
   * @return [type]                [接口返回数据]
   */
  function http($url, $params, $method = 'GET', $header = array(), $timeout = 5)
  {
      // POST 提交方式的传入 $set_params 必须是字符串形式
      $opts = array(
          CURLOPT_TIMEOUT => $timeout,
          CURLOPT_RETURNTRANSFER => 1,
          CURLOPT_SSL_VERIFYPEER => false,
          CURLOPT_SSL_VERIFYHOST => false,
          CURLOPT_HTTPHEADER => $header
      );
      /* 根据请求类型设置特定参数 */
      switch (strtoupper($method)) {
          case 'GET':
              $opts[CURLOPT_URL] = $url . '?' . http_build_query($params);
              break;
          case 'POST':
              $params = http_build_query($params);
              $opts[CURLOPT_URL] = $url;
              $opts[CURLOPT_POST] = 1;
              $opts[CURLOPT_POSTFIELDS] = $params;
              break;
          case 'DELETE':
              $opts[CURLOPT_URL] = $url;
              $opts[CURLOPT_HTTPHEADER] = array("X-HTTP-Method-Override: DELETE");
              $opts[CURLOPT_CUSTOMREQUEST] = 'DELETE';
              $opts[CURLOPT_POSTFIELDS] = $params;
              break;
          case 'PUT':
              $opts[CURLOPT_URL] = $url;
              $opts[CURLOPT_POST] = 0;
              $opts[CURLOPT_CUSTOMREQUEST] = 'PUT';
              $opts[CURLOPT_POSTFIELDS] = $params;
              break;
          default:
              throw new Exception('不支持的请求方式！');
      }
      /* 初始化并执行curl请求 */
      $ch = curl_init();
      curl_setopt_array($ch, $opts);
      $data = curl_exec($ch);
      $error = curl_error($ch);
      curl_close($ch);
      return $data;
  }
  ```

## 点击按钮切换表格显示类别

- 表格主页面点击按钮切换表格显示数据种类

- 首先在类中的listSearch写好对应的按钮,按钮上显示不同种类的数据条数,使用sqlNum查询出.

- hidden隐藏域带的是默认展示的按钮数据种类,对应workFlow的状态

- 对应按钮上的js方法传入点击这个按钮时希望显示的数据种类的状态.

  ```php
  $waiteNum = sqlNum("buyCar"," workFlow = '退款中' ");
  $yetNum = sqlNum("buyCar"," workFlow = '已通过' or workFlow = '已驳回'");
  $result['html'] = "";
  $result['html'] .=
  "<div style='margin: 12px;'>
      <span class='bigSpan choice' onclick=\"switchAudit(this,'退款中')\">待审核列表<em class='numEm'>{$waiteNum}</em></span>
      <span class='bigSpan'  onclick=\"switchAudit(this,'已通过')\">已审核列表<em class='numEm'>{$yetNum}</em></span>
                  </div>".
              hidden(array("name" => "workFlow", "value" => "退款中")).
  ```

- css样式写好放到`extend.css`中

  ```css
  .choice{
      background-color: #3e97ff!important;
      color: #ffffff!important;
  }
  .bigSpan{
      padding: 0px 6px 0 6px;
      border: 1px solid #cddba2;
      border-radius: 4px;
      background-color: #ffffff;
      color: #7d6b6b;
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
      font-size: 20px;
      margin: 10px;
      position: relative;
  }
  .numEm{
      position: absolute;
      color: black;
      top: -11px;
      right: -16px;
      width: 20px;
      background-color: yellow;
      text-align: center;
      font-style: normal;
      font-size: 13px;
  }
  ```

- js方法放到`extend.js`中

  ```js
  /**********切换审核列表**********/
  function switchAudit(e,workFlow) {
      $(".bigSpan").removeClass("choice");
      $(e).addClass("choice");
      $("[name='workFlow']").val(workFlow);
      searchFormSub('refundAudit');
  }
  ```

- 如果每点击一次按钮,切换状态时只切换包含一种状态,那就直接把workFlow标签的内容拿到放到`$euqal`中

- 如果是切换的状态包含不止一种,比如`workFlow = '已通过' or workFlow = '已退款'`,那就要在listResult中做判断,如果workFlow标签不为空,就判断传过来的是什么,只要是对应的标签的值,就生成一个变量,变量的内容是SQL语句的片段.放到sql语句的where后面即可.

  ```php
   if(!empty($data['post']['workFlow'])){
              if($data['post']['workFlow']=="已通过"){
                  $workFlow = "and b.workFlow = '已通过' or b.workFlow = '已驳回'";
              }else{
                  $workFlow = "and b.workFlow = '{$data['post']['workFlow']}'";
              }
          }
  ```

---

## 挑选限定时间活动中时间最合适的那个

- 有一种情况,这趟车,开车前十二小时之内退款打五折,十小时内退款打三折,三小时内退款打一折.

- 我们去用当前时间判断很可能有个时间,同时满足十小时和十二小时内,那怎么筛选出最合适的退款比例呢?

  ```php
  $refundRatios = array();
              $distanceStartTime = array();
              $driver = query("driver","id = '{$array['driverId']}'");
              $journey = query("journey","id = '{$array['journeyId']}'");
              $date = $journey['date']." ".$journey['startTime'];//将车程中的出发日期和出发时间拼接
              $refunds = sqlQueryAll("select * from refund where journeyId = '{$journey['id']}'");//查找该车程所有退款信息
              foreach ($refunds as $refund){
                  //将现在的时间加上当前条退款信息中的距离出发时间(h)
                  $resultTime = date('Y-m-d H:i:s', strtotime('+'.$refund['distanceStartTime'].'hour'));
                  //如果加完之后的结果比开车出发时间早就说明退款条件成立,但是同时可能有好几条成立的
                  if(strtotime($resultTime)<strtotime($date)){
                      //把每条成立的退款比例和距离发车时间存进两个空数组
                      $refundRatios[] = $refund['refundRatio'];
                      $distanceStartTime[] = $refund['distanceStartTime'];
                  }
              }
              if(count($distanceStartTime)>0){
                  //拿出距离发车时间数组中最小的那个时间,那就是适用的那条退款信息
                  $minTime = min($distanceStartTime);
                  //倒转距离发车时间数组,通过min函数取得的最小时间值,拿到对应的键$key
                  $reserve = array_flip($distanceStartTime); //颠倒那个我们想删掉某个元素的数组
                  $key = $reserve[$minTime];
                  $realRatio = $refundRatios[$key];//通过对应的键在另一个退款比例中找到对应的值,那这个比例去乘付款金额既得到退款金额
              }else{
                  $realRatio = 1;
              }
  ```


## 二维码

- 二维码生成

- 先写一个链接定位到你处理数据的接口,用get携带上必须的参数,再用下面的链接脸上urlencode处理后的链接,返回给前端,放到src里就是一张二维码图片

  ```php
  //礼包
      $url = root."m/mIndex.php?shareId=".$kehu['khid']."&bagId=";
      $shareQRCode = root."pay/wxpay/wxScanPng.php?url=".urlencode($url);//分享图片;
  ```

## 微信

### 收付款

- 微信退款类

  ```php
  /**
   * 微信支付
   */
  class WxPay
  {
      public static $appid;       #公众账号ID
      public static $mch_id;      #商户号
      /**
       * 微信退款
       * @param string $transaction_id    微信订单号(pay_payId)
       * @param string $out_refund_no     商户退款单号
       * @param Int $total_fee        订单金额（单位为分）
       * @param Int $refund_fee       退款金额（单位为分）
       * @return array
       * @author r7
       */
      /**[return_code] => SUCCESS
      [return_msg] => OK
      [appid] => wx7e667e862c0c4d65
      [mch_id] => 1503228781
      [nonce_str] => VvIMLNr0lkQWcGZr
      [sign] => 9CEA0EA78D50CAAB5011497AEF81F5E5
      [result_code] => FAIL
      [err_code] => NOTENOUGH
      [err_code_des] => 交易未结算资金不足，请使用可用余额退款
       */
      public static function refund($transaction_id,$out_refund_no,$total_fee,$refund_fee)
      {
          #退款参数
          $refundorder = [
              'appid'         => para('wxAppid'),         #公众账号ID
              'mch_id'        => para('wxPayId'),         #商户号
              'nonce_str'     => self::getNonceStr(),     #随机字符串
              'transaction_id'=> $transaction_id,         #微信订单号
              'out_refund_no' => $out_refund_no,          #商户退款单号
              'total_fee'     => $total_fee * 100,        #订单金额（单位为分）
              'refund_fee'    => $refund_fee * 100        #退款金额（单位为分）
          ];
  
          $refundorder['sign'] = self::makeSign($refundorder);    #签名
  
          #请求数据,进行退款
  
          #将要提交的参数生成xml文件
          $xml = self::ToXml($refundorder);
          //以post方式提交xml到对应的接口url，并获得prepay_id
          $url = "https://api.mch.weixin.qq.com/secapi/pay/refund";
          $result = self::curlPost($url, $xml);//curl($url,$xml);
  
          $res = xmlToArray($result);
  
          /*
          $xmldata = self::array2xml($refundorder);
          $url = 'https://api.mch.weixin.qq.com/secapi/pay/refund';
          $res = self::curl_post_ssl($url, $xmldata);
  
          if(!$res){
              return array('status'=>0, 'msg'=>"Can't connect the server" );
          }
          */
          //发起退款失败
          if( !$res ){
              return array('status'=>201,'msg'=>'不能连接服务器');
          }
          //退款事变
          if(strval($res['result_code']) == 'FAIL'){
              return array('status'=>201, 'msg'=>strval($res['err_code']).':'.strval($res['err_code_des']));
          }
          //通信标识失败
          if(strval($res['return_code']) == 'FAIL'){
              return array('status'=>201, 'msg'=>strval($res['return_msg']));
          }
          return $res;
      }
      /**
       * 输出xml字符
       * @throws WxPayException
       **/
      public static function ToXml($arr)
      {
          $xml = "<xml>";
          foreach ($arr as $key=>$val)
          {
              if (is_numeric($val)){
                  $xml.="<".$key.">".$val."</".$key.">";
              }else{
                  $xml.="<".$key."><![CDATA[".$val."]]></".$key.">";
              }
          }
          $xml.="</xml>";
          return $xml;
      }
      public static function curlPost($url = '', $postData = '', $options = array())
      {
          if (is_array($postData)) {
              $postData = http_build_query($postData);
          }
          $ch = curl_init();
          curl_setopt($ch, CURLOPT_URL, $url);
          curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
          curl_setopt($ch, CURLOPT_POST, 1);
          curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);
          curl_setopt($ch, CURLOPT_TIMEOUT, 30); //设置cURL允许执行的最长秒数
          if (!empty($options)) {
              curl_setopt_array($ch, $options);
          }
          //https请求 不验证证书和host
          curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
          curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
          //第一种方法，cert 与 key 分别属于两个.pem文件
          //默认格式为PEM，可以注释
          curl_setopt($ch,CURLOPT_SSLCERTTYPE,'PEM');
          curl_setopt($ch,CURLOPT_SSLCERT,serverRoot.'/pay/wxpay/apiclient_cert.pem');
          //默认格式为PEM，可以注释
          curl_setopt($ch,CURLOPT_SSLKEYTYPE,'PEM');
          curl_setopt($ch,CURLOPT_SSLKEY,serverRoot.'/pay/wxpay/apiclient_key.pem');
  
          $data = curl_exec($ch);
          curl_close($ch);
          return $data;
      }
      /**
       * 生成随机数
       * @param string $prefix    随机数前缀
       * @param integer $len      随机数总长度
       * @return mixed
       * @author r7
       */
      public static function getNonceStr($prefix = 'raul',$len = 20)
      {
          $time = time().'';
          $id = $prefix;
          $prefix_len = strlen($prefix);  #前缀长度
          $j = $len - $prefix_len - 4;    #循环次数
          for ($i=0; $i < $j; $i++) {
              $id .= $time[mt_rand(0,9)];
          }
          $id .= mt_rand(1000,9999);
          return $id;
      }
      /**
       * 生成签名
       * @return 签名，本函数不覆盖sign成员变量，如要设置签名需要调用SetSign方法赋值
       */
      public static function makeSign($arr)
      {
          //签名步骤一：按字典序排序参数
          ksort($arr);
          $string = self::ToUrlParams($arr);
          //签名步骤二：在string后加入KEY
          $string = $string . "&key=".para('wxPayKey');
          //签名步骤三：MD5加密
          $string = md5($string);
          //签名步骤四：所有字符转为大写
          $result = strtoupper($string);
          return $result;
      }
      /**
       * 格式化参数格式化成url参数
       * @param array $arr
       */
      public static function ToUrlParams($arr)
      {
          $string = "";
          foreach ($arr as $k => $v)
          {
              if($k != "sign" && $v != "" && !is_array($v)){
                  $string .= $k . "=" . $v . "&";
              }
          }
          $string = trim($string, "&");
          return $string;
      }
  }
  ```

- 微信退款方法使用

  ```php
  /******退款*******/
  $pay = query("pay", " orderIdGroup LIKE '%{$data['post']['id']}%' and workFlow = '已支付' ");
  $returnMoney = $pay['money'];
  $res = WxPay::refund($pay['payId'], $data['post']['id'], $pay['money'], $returnMoney);
  if ($res['return_msg'] == 'OK') {
      $json['warn'] = update(array("table" => "buyCar","field" => array("workFlow"=>"已取消","updateTime"=>$time),"where" => "id = '".$data['post']['id']."'"));
  }
  /******退款*******/
  ```

### 获取ID

- 微信网页获取openid

  ```php
  /***********获取微信信息*************/
  $code      = $post['code'];
  $appId     = para('wxAppid');
  $appSecret = para('wxAppSecret');
  //获取openid
  $token  = json_decode(file_get_contents("https://api.weixin.qq.com/sns/oauth2/access_token?appid={$appId}&secret={$appSecret}&code={$code}&grant_type=authorization_code"), true);
  $openid = $token['openid'];
  ```

- 微信小程序获取openid

  ```php
  /***********获取微信信息*************/
  $code      = $post['code'];
  $appId     = para('wxAppid');
  $appSecret = para('wxAppSecret');
  $token = json_decode(file_get_contents("https://api.weixin.qq.com/sns/jscode2session?appid={$appId}&secret={$appSecret}&js_code={$code}&grant_type=authorization_code"), true);
  $openid = $token['openid'];
  ```

  

## SQL语句

- sql语句拼接完整路径

- 千万不要忘了把root左右的单引号加上

  ```php
  $lunbo = sqlQueryAll("select concat('".root."',src) as src from img where type = 'h5轮播'");
  ```

---

- union all 多条SQL语句,可以在最后使用order by ,就会把多条查询出的结果排序,但是order by后面的字段.必须是在每条SQL select后面都出现过的字段

---

- 现在卖车票,顾客可一次买多张,买多张的同时,其实生成个多个订单,但是这多个订单有相同的订单号.
- 现在需要把这多个订单的出发到达具体地点,出发具体时间,上车地点,以及总价查询出来.

- 同时还要给前端传递相同订单号的订单有几个,那么这种时候就需要在SQL语句中嵌套小的SQL语句.

- 但是要注意,在想拼接一次查询的多个订单号相同的订单ID的时候,需要使用`GROUP_CONCAT`函数而不是`concat`

- 否则就会出现报错`#1242 - Subquery returns more than 1 row`,因为一次查一条,concat确是要拼接多条,数据行数就有问题

```sql
select j.date,j.startTime,j.journeyTime,b.workFlow, 
j.oneType,j.originRegion,j.endRegion,j.originStation,
j.endStation,s.address,b.buyCarNum,
(select COUNT(bu.id) FROM buyCar as bu 
 WHERE bu.buyCarNum = b.buyCarNum) as num,
(select GROUP_CONCAT(buy.id) from buyCar as buy 
 where buy.buyCarNum = b.buyCarNum) as ids,
(select sum(buyc.money) from buyCar as buyc 
 where buyc.buyCarNum = b.buyCarNum) as money
            from buyCar as b 
            left join journey as j on b.journeyId = j.id 
            left join baseLine as ba on j.baseLineId = ba.id
            left join stationAndPrice as s on ba.id = s.baseLineId where b.khid = '{$post['khid']}'
            GROUP BY b.buyCarNum
```

---

- mysql IN查询将数组转换为字符串方法

  ```php
   $idStr = "'" . implode("','", $post['list']) . "'";
  ```

---

- 选择日期,没有时分秒,SQL**判断在当天**的情况该怎么做.

- 首先拿到应该的日期,时间选择器选择或者是今天

- 然后**拼接零点零分零秒.**

- 然后使用date函数加一天

- 最后在mysql中使用between即可.但是注意,**日期要加引号**

  ```php
  $date = $post['date']." 00:00:00";//选择的日期
      $afterOneDay = date('Y-m-d H:i:s', strtotime("+1day", strtotime($date)));//选择日期一天之后
      $buyCarNum = sqlNum("buyCar","roundId = '{$rounds[0]['roundId']}' and ( workFlow = '待消费' or workFlow = '退款中') and time between  '{$date}' and '{$afterOneDay}'");
  ```

## 比较判断

- PHP中判断字符串==0时,得到的一直会为true,所以做判断时要小心,等于就用===,不等于用!==

## 流程

- 在一连串的if/else中,可能**对于一个数据你进行过几次数据库更新**,但是你在拿数据时,还用的是代码最顶端查到的那个变量例如`$kehu`中的数据,这样是错误的,因为你想进行一连串的数据改变,但是最顶端的那个变量从查出来就是定了的,不会因为你中途几次更新就也变化,一定要注意再次改变一个值时,**重新查询**数据库.

## 数据回显

- 时间如果为空,在详情页面会出现时间选择框初始选择0000-00-00或0100-01-01的情况,非常麻烦

- 使用封装函数,三元运算符去解决这个问题比较合适.

  ```php
  function emptyTime($time){
      $time=='0000-00-00'||$time=='0100-01-01'?$trueTime='':$trueTime=$time;
      return $trueTime;
  }
  ```

## 正则表达式

**一、数字校验**

数字：

> ^[0-9]*$

n位的数字：

> ^\d{n}$

至少n位的数字：

> ^\d{n,}$

m-n位的数字：

> ^\d{m,n}$

零和非零开头的数字：

> ^(0|[1-9][0-9]*)$

非零开头的最多带两位小数的数字：

> ^([1-9][0-9]*)+(.[0-9]{1,2})?$

带1-2位小数的正数或负数：

> ^(\-)?\d+(\.\d{1,2})?$

正数、负数、和小数：

> ^(\-|\+)?\d+(\.\d+)?$

有两位小数的正实数：

> ^[0-9]+(.[0-9]{2})?$

有1~3位小数的正实数：

> ^[0-9]+(.[0-9]{1,3})?$

非零的正整数：

> ^[1-9]\d*$ 或 ^([1-9][0-9]*){1,3}$ 或 ^\+?[1-9][0-9]*$

非零的负整数：

> ^\-[1-9][]0-9″*$ 或 ^-[1-9]\d*$

非负整数：

> ^\d+$ 或 ^[1-9]\d*|0$

非正整数：

> ^-[1-9]\d*|0$ 或 ^((-\d+)|(0+))$

非负浮点数：

> ^\d+(\.\d+)?$ 或 ^[1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0$

非正浮点数：

> ^((-\d+(\.\d+)?)|(0+(\.0+)?))$ 或 ^(-([1-9]\d*\.\d*|0\.\d*[1-9]\d*))|0?\.0+|0$

正浮点数：

> ^[1-9]\d*\.\d*|0\.\d*[1-9]\d*$ 或 ^(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*))$

负浮点数：

> ^-([1-9]\d*\.\d*|0\.\d*[1-9]\d*)$ 或 ^(-(([0-9]+\.[0-9]*[1-9][0-9]*)|([0-9]*[1-9][0-9]*\.[0-9]+)|([0-9]*[1-9][0-9]*)))$

浮点数：

> ^(-?\d+)(\.\d+)?$ 或 ^-?([1-9]\d*\.\d*|0\.\d*[1-9]\d*|0?\.0+|0)$

**二、字符校验**

汉字：

> ^[\u4e00-\u9fa5]{0,}$

英文和数字：

> ^[A-Za-z0-9]+$ 或 ^[A-Za-z0-9]{4,40}$

长度为3-20的所有字符：

> ^.{3,20}$

由26个英文字母组成的字符串：

> ^[A-Za-z]+$

由26个大写英文字母组成的字符串：

> ^[A-Z]+$

由26个小写英文字母组成的字符串：

> ^[a-z]+$

由数字和26个英文字母组成的字符串：

> ^[A-Za-z0-9]+$

由数字、26个英文字母或者下划线组成的字符串：

> ^\w+$ 或 ^\w{3,20}$

中文、英文、数字包括下划线：

> ^[\u4E00-\u9FA5A-Za-z0-9_]+$

中文、英文、数字但不包括下划线等符号：

> ^[\u4E00-\u9FA5A-Za-z0-9]+$ 或 ^[\u4E00-\u9FA5A-Za-z0-9]{2,20}$

可以输入含有^%&’,;=?$\”等字符：

> [^%&',;=?$\x22]+

禁止输入含有~的字符：

> [^~\x22]+

**三、特殊需求处理**

Email地址：

> ^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$

域名：

> [a-zA-Z0-9][-a-zA-Z0-9]{0,62}(/.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+/.?

InternetURL：

> [a-zA-z]+://[^\s]* 或 ^http://([\w-]+\.)+[\w-]+(/[\w-./?%&=]*)?$

手机号码：

> ^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$

电话号码(“XXX-XXXXXXX”、”XXXX-XXXXXXXX”、”XXX-XXXXXXX”、”XXX-XXXXXXXX”、”XXXXXXX”和”XXXXXXXX)：

> ^($$\d{3,4}-)|\d{3.4}-)?\d{7,8}$

国内电话号码(0511-4405222、021-87888822)：

> \d{3}-\d{8}|\d{4}-\d{7}

身份证号(15位、18位数字)：

> ^\d{15}|\d{18}$

短身份证号码(数字、字母x结尾)：

> ^([0-9]){7,18}(x|X)?$ 或 ^\d{8,18}|[0-9x]{8,18}|[0-9X]{8,18}?$

帐号是否合法(字母开头，允许5-16字节，允许字母数字下划线)：

> ^[a-zA-Z][a-zA-Z0-9_]{4,15}$

密码(以字母开头，长度在6~18之间，只能包含字母、数字和下划线)：

> ^[a-zA-Z]\w{5,17}$

强密码(必须包含大小写字母和数字的组合，不能使用特殊字符，长度在8-10之间)：

> ^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,10}$

日期格式：

> ^\d{4}-\d{1,2}-\d{1,2}

一年的12个月(01～09和1～12)：

> ^(0?[1-9]|1[0-2])$

一个月的31天(01～09和1～31)：

> ^((0?[1-9])|((1|2)[0-9])|30|31)$

钱的输入格式：

有四种钱的表示形式我们可以接受:”10000.00″ 和 “10,000.00″, 和没有 “分” 的 “10000″ 和 “10,000″：

> ^[1-9][0-9]*$

这表示任意一个不以0开头的数字，但是，这也意味着一个字符”0″不通过，所以我们采用下面的形式：

> ^(0|[1-9][0-9]*)$

一个0或者一个不以0开头的数字.我们还可以允许开头有一个负号：

> ^(0|-?[1-9][0-9]*)$

这表示一个0或者一个可能为负的开头不为0的数字.让用户以0开头好了.把负号的也去掉，因为钱总不能是负的吧.下面我们要加的是说明可能的小数部分：

> ^[0-9]+(.[0-9]+)?$

必须说明的是，小数点后面至少应该有1位数，所以”10.”是不通过的，但是 “10″ 和 “10.2″ 是通过的：

> ^[0-9]+(.[0-9]{2})?$

这样我们规定小数点后面必须有两位，如果你认为太苛刻了，可以这样：

> ^[0-9]+(.[0-9]{1,2})?$

这样就允许用户只写一位小数。下面我们该考虑数字中的逗号了，我们可以这样：

> ^[0-9]{1,3}(,[0-9]{3})*(.[0-9]{1,2})?$

1到3个数字，后面跟着任意个 逗号+3个数字，逗号成为可选，而不是必须：

> ^([0-9]+|[0-9]{1,3}(,[0-9]{3})*)(.[0-9]{1,2})?$

备注：这就是最终结果了，别忘了”+”可以用”*”替代。如果你觉得空字符串也可以接受的话(奇怪，为什么?)最后，别忘了在用函数时去掉去掉那个反斜杠，一般的错误都在这里

xml文件：

> ^([a-zA-Z]+-?)+[a-zA-Z0-9]+\\.[x|X][m|M][l|L]$

中文字符的正则表达式：

> [\u4e00-\u9fa5]

双字节字符(包括汉字在内，可以用来计算字符串的长度(一个双字节字符长度计2，ASCII字符计1))：

> [^\x00-\xff]

空白行的正则表达式(可以用来删除空白行)：

> \n\s*\r

HTML标记的正则表达式(网上流传的版本太糟糕，上面这个也仅仅能部分，对于复杂的嵌套标记依旧无能为力)：

> <(\S*?)[^>]*>.*?|<.*? />

首尾空白字符的正则表达式(可以用来删除行首行尾的空白字符(包括空格、制表符、换页符等等)，非常有用的表达式)：

> ^\s*|\s*$或(^\s*)|(\s*$)

腾讯QQ号(腾讯QQ号从10000开始)：

> [1-9][0-9]{4,}

中国邮政编码(中国邮政编码为6位数字)：

> [1-9]\d{5}(?!\d)

IP地址(提取IP地址时有用)：

> \d+\.\d+\.\d+\.\d+

IP地址：

> ((?:(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d)\\.){3}(?:25[0-5]|2[0-4]\\d|[01]?\\d?\\d))

## JS

- jquery**修改JS方法中的参数值**该如何修改?

- 首先通过节点拿到对应JS方法的标签,然后使用attr,直接把onclick属性完全改变.等于重写一遍标签上的方法字符.

  ```js
  //点击切换主题方法
      function changeTheme (node,themeId){
          //移除原选中按钮选中样式
          $('.choose').removeClass('choose');
          //给点击按钮添加选种样式
          $(node).addClass('choose');
          //异步返回主题相关信息部分
          $.post(root+"control/data.php?type=getRoom",{themeId:themeId},function(data){
              $(node).parent().parent().find(".allRoom").html(data.allRoom);//改变房间内容
              $(node).parent().parent().find(".price").text("¥"+data.price);//改变价格显示
              $(node).parent().parent().find(".palceButton").removeAttr('onclick').attr('onclick',"layer('placeAnOrder',{'themeId':'"+themeId+"'})");//改变layer方法参数
          },"json");
      }
  ```

---

- jquery**获取相同类标签的所有值**

  ```js
  var btn = $('.btn').val();//只能获得这个类标签的第一个值
   
  //获得一组值
  var btns = new Array();
  $(".btn").each(function(){
      btns[key] = $(this).val();
      //  或者 btns[key] = $(value).val();
  })
  ```

---

- jquery**判断某标签存不存在**

- 在jQuery中，**jQuery对象永远都有返回值**，所以$("someID") 总是TRUE ，IF语句没有起到任何判断作用。正确的写法应该是：

  ```js
  if ( $("#someID").length > 0 ) { 
     $("#someID").text("hi"); 
  } 
  ```

---

- jquery的`$.inArray`方法,如果元素不在数组中返回-1,做判断的时候要用是否等于-1来判断才有用.

---

- JS中可能有拼接多个字符为一个字符串,每一个后面都跟逗号的情况

- 这样的话最后一个后面也有逗号.不好看,所以用以下方法解决

- 把字符串从第一个字符开始切割,到倒数第二个字符为止

  ```js
  repetitionArr = repetitionArr.substring(0,repetitionArr.length-1);
  ```

---

- jquery判断checkbox是否是选中状态的方法

  ```js
  方法一：
  if ($("#checkbox-id").get(0).checked) {
      // do something
  }
  
  方法二：
  if($('#checkbox-id').is(':checked')) {
      // do something
      //这个管用了,第三个失败了
  }
  
  方法三：
  if ($('#checkbox-id').attr('checked')) {
      // do something
  }
  ```

---

- js保留小数点后两位

  ```js
  parseFloat(数字).toFixed(2);
  ```

---

- jquery的foreach

  ```js
  $('td').find(".overtimeHidden").find('input').each(function() 
  {
  totalMoney += $(this).attr('count')*1*$(this).attr('price');
  });
  ```

----

- 手动设置checkbox不选中

  ```js
  $(node).prop('checked', false);
  ```

---

- 下拉选中的选项value

  ```js
  $('[name=discount]').children('option:selected').val();
  ```

---

- js的几种数组**遍历**方法

  `https://blog.csdn.net/function__/article/details/79555301`

---

- jquery**替换**元素

- ```js
  $(content).replaceWith(selector)
  ```

### 动态变动Layer长度

- 动态添加layer中的元素比如选择框,长度会变动,很不好看

- 使用jquery的htight同时改变两个元素的长度即可完美变动.

  ```js
  //拿到win和winAuto标签本身
  let win = $(node).parent().parent().parent().parent().parent().parent().parent();
  let winAuto = $(node).parent().parent().parent().parent().parent().parent();
  //拿到win和winAuto标签的长度
  let heightWin = $(node).parent().parent().parent().parent().parent().parent().parent().height();
  let heightWinAuto = $(node).parent().parent().parent().parent().parent().parent().height();
  ```

  ```js
  //使用height方法及时变动长度即可,亲测下拉列表长度为36,文本框为38
  win.height(heightWin*1+36);
  winAuto.height(heightWinAuto*1+36);
  ```



## 弹出层

### 参数

- 如果遇到layer方法,后面的参数是JSON,最好是单独写成数组,然后转成JSON再放到layer里.

  ```php
  	$layerArr = [
  						'themeId'=>$buyCar['themeId'],
  						'category'=>$buyCarShop['type'],
  						'money'=>$buyCar['money'],
  						'khid'=>$kehu['khid'],
  						'userTel'=>$kehu['userTel'],
  						'themeName'=>$buyCarTheme['themeName'],
  						'themeTime'=>$buyCarTheme['themeTime'],
  						'themePrice'=>$buyCarTheme['price'],
  						'roundId'=>$buyCar['roundId'],
  						'presetTime'=>$buyCar['presetTime'],
  						'number'=>$buyCar['number'],
  						'vip'=>$svip,
  						'crowd'=>$buyCar['crowd'],
  						'source'=>$buyCar['source'],
  						'isFree'=>$buyCar['isFree'],
  						'isPack'=>$buyCar['isPack'],
  						'coupon'=>$buyCar['couponUse'],
  						'overtime'=>$buyCar['overtime'],
  						'discountType'=>$buyCar['discountType'],
  						'discountNum'=>$buyCar['discountNum'],
  						'freeText'=>$buyCar['freeText'],
  						'payType'=>$payType,
  						'staffCount'=>$buyCar['staffCount'],
  						'consumeCount'=>$buyCar['consumeCount']
  		];
  		$layerArr = json_encode($layerArr);
  		
  ```

  ```php
  $layer = "<span class='placeButton btn cyan mini' onclick='layer(\"placeAnOrder\",$layerArr)'>处理下单</span>&nbsp;
  		<script>
  		$(function() {
  			//要执行的js代码段
  			console.log('下单按钮节点');
  			console.log($('.placeButton'));
  			$('.placeButton').click();
  		});
  		</script>";
  ```

- 如果layer方法里的json参数中还有JSON.记得要转义之后再放进数组.

  ```php
  $payType = addslashes($buyCar['payType']);
  		$payType = str_replace(" ",'',$payType);
  ```

- 并且layer方法要用单引号包裹,然后第一个参数也就是弹窗名用转义双引号包裹.

## HTML5

### 模糊查询输入框

- 模糊查询的文本输入框

  ```javascript
  <input type=\"text\" value=\"".$info['unit']."\" name=\"unit\" placeholder=\"客户单位\" class=\"form-control\" id=\"batch\"  list=\"batch_list\" autocomplete=\"off\">
                      <!-- 选择内容 -->
                      <datalist id=\"batch_list\">
                      </datalist>
                      <!-- 动态加载选择的内容 -->
                      <script>
                          $('input#batch').bind('keyup', function () {
                              var batch = $('input#batch').val();
                              if(batch!=''&&batch!=undefined&&batch!=null){
                                $.ajax({
                                 url: \"".root."control/adIndex.php?cla=contract&fun=getUnit\",
                                  type: \"POST\",
                                  dataType: 'json',
                                  data: {'batch': batch},
                                  async: false,
                                  success: function (arg) {
                                      $('datalist#batch_list').empty();
                                      console.log(arg);
                                      
                                      if(arg!=''){
                                          for (var i = 0; i < arg.length; i++) {
                                          //这里的.expressNum就是传递到前端的数组的键
                                          console.log('下拉客户ID');
                                          console.log(arg[i].khid);
                                          var add_options = '<option value=\"' + arg[i].khid + '\">'+ arg[i].unit + '</option>';
                                           $('datalist#batch_list').append(add_options);
                                      }
                                    }
                                      
                                 }
                               })  
                              }
                             
                           });
                          $('#batch').change(function() {
                              if($('#batch').val()!=''&&$('#batch').val()!=undefined&&$('#batch').val()!=null){
                                  console.log('隐藏标签');
                                  console.log($('#khid'));
                                   console.log('选中的单位的客户ID');
                                  console.log($('#batch').val());
                                  
                                  $('#khid').attr('value',$('#batch').val());
                              $.post(root+\"control/adIndex.php?cla=contract&fun=getUnitString\",{khid:$('#batch').val()},function(data){
                                  if(data.unit!=''&&data.unit!=undefined&&data.unit!=null){
                                      $('#batch').val(data.unit);
                                  }
                              },\"json\")
                              }
                              
                          });
                      </script>
  ```

  

  ```php
  //上面js中异步模糊查询获取数据的函数
  public function getExpress(){
      $checkReport = $this->sqlQueryAll("select expressNum from checkReport where '".$this->post['batch']."%'");
      return json_encode($checkReport);
  }
  ```

### 单选

- 有时候你的一些字段使用0,1表示不同的状态,这时如果想使用单选,选择之后实际上传递的是字符串

- 如果想显示字符串,传递0和1,就得这样打乱选项的键的顺序即可.

- 但是这样会有个问题,不选中就是false就是0,会默认选中键为0的选项

  ```php
  radio(array("name" => "isEnsure","value"=>array(1=>'已确认',0=>'未确认'), 'title' => '本人是否确认'))
  ```

### H5输入框校检

- 可以自定义input type属性的方法

  ```php
  /**********生成单行文本框********************************************************
      $data = array(
      "name" => "文本框name",
      "id" => "文本框id",
      "laydate" => array()//"调用laydate日历框架，数组内可以放一些额外参数",
      "title" => "文本框标题",
      "value" => "文本框value",
      "class" => "文本框的class",
      "click" => "鼠标点击事件函数名",
      "blur" => "元素失去焦点事件函数名",
      "keyup" => "某个键盘按键被松开时的函数名",
      "other" => "串联其他属性",
      );
       */
  function textType($data){
      $attribute = $js = "";
      if(!empty($data['id'])){
          $attribute .= " id='".$data['id']."' ";
      }elseif(array_key_exists("laydate",$data)){//如果存在laydate键名
          $id = suiji();
          $attribute .= " id='".$id."' ";
          $json = "";
          foreach((array)$data['laydate'] as $key => $value){
              $json = ",".$key.":'".$value."'";
          }
          $js = "<script>$(function(){laydate.render({elem:'#".$id."'".$json."});});</script>";
      }
      if(!empty($data['title'])){
          $attribute .= "  placeholder='".$data['title']."' title='".$data['title']."' ";
      }
      if(!empty($data['value'])){
          $attribute .= " value='".$data['value']."' ";
      }
      if(!empty($data['class'])){
          $attribute .= " class='".$data['class']."' ";
      }
      if(!empty($data['click'])){
          $attribute .= " onclick='".$data['click']."(this)' ";
      }
      if(!empty($data['blur'])){
          $attribute .= " onblur='".$data['blur']."(this)' ";
      }
      if(!empty($data['keyup'])){
          $attribute .= " onkeyup='".$data['keyup']."(this)' ";
      }
      //规定input的正则表达式
      if(!empty($data['pattern'])){
          $attribute .= " pattern='".$data['pattern']."' ";
      }
      //规定input的type属性
      if(!empty($data['type'])){
          $type = $data['type'];
      }else{
          $type = "type";
      }
      $html = "<input type='$type' name='".$data['name']."' autocomplete='off' ".$attribute.$data['other'].">".$js."\n";
      return $html;
  }
  ```

---

- 不会影响html5中input标签的required属性的layer生成

- 因为这个属性必须是表单submit时才可以,而之前的方法表单onsubmit是return false,

- 现在把提交按钮设置type=submit,然后把原先绑定在提交按钮上的JS提交方法放到form标签的onsubmit处

- 注意这里的form的action属性一定要写为javascript:void(0),不然就不会正常异步提交

  ```php
  public function layerEditTest($data){
      //表单名称
      $form = $this->get['cla'].ucwords($this->get['fun'])."Form";
      //拼接隐藏域
      $hidden = "";
      if(!empty($this->post['id'])){
          $hidden .= hidden(array("name" => "id","value" => $this->post['id']));//弹出层表单主索引
      }
      if($data['hidden']){
          $hidden .= $data['hidden'];
      }
      //生成提交按钮
      if(empty($data['button'])){
          if(empty($data['formTwo'])){
              $subForm = $form;
          }else{
              $subForm = $form.",".$data['formTwo'];
          }
          $url = root."control/adIndex.php?cla=".$this->get['cla']."&fun=".$this->get['fun']."Edit";
          //这里的提交按钮全都改成type=submit的简单提交按钮
          if(!empty($data['upload'])){
              $js = "upForm('".$subForm."','".$url."')";
              //这里就是上传图片的新增详情页面自定义js方法的提交按钮
              $button = "<input  type='submit' class='button' value='确认提交'>";
          }else{
              $js = "subForm('".$subForm."','".$url."')";
              $button = "<input  type='submit' class='button' value='确认提交'>";
          }
  
  
      }else{
          $button = $data['button'];
      }
      $data['table'][$hidden] = $button;
      //生成table
      $tr = "";
      foreach($data['table'] as $key => $value){
          if(is_int($key)){
              $key = "";
          }
          $tr .= "<tr><td>".$key."</td><td>".$value."</td></tr>";
      }
      //注意这里的form的action属性一定要写为javascript:void(0),不然就不会正常异步提交
      //把原本绑定在提交按钮上的js提交方法放在这里的onsubmit
      $html .= "
  		<form name='".$form."' onsubmit=\"$js\"  action=\"javascript:void(0)\">
  		    <style>table img{width: 130px!important;height: 130px!important;}</style>
  			<table class='tableRight'>".$tr."</table>
  		</form>
  		";
      return $html;
  }
  ```


---

## OFFICE

- **php在线预览office文件**

- 这个还是推荐你直接使用微软官方提供的解析服务吧，挺方便的，效果不错。

  使用也超级简单，直接引用office文件绝对地址就可以。像这样：

  `https://view.officeapps.live.com/op/view.aspx?src=http://www.a.com/test.doc`

  其中`http://www.a.com/test.doc`这个就是文档的绝对地址，直接iframe调用一下拼接好的地址，就可以看到效果了，试试吧

  备注： office系列全家所有文件都可以预览的，文档，表格，ppt都没问题



